<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="因为之前实施部署达梦数据库，通常是只部署开发环境、测试环境，生成环境的数据库并没有实践在项目中实践过，受限于工作项目，开发、测试环境通常只有一台数据库服务器，部署的单机版。\n对于集群版本一直没有机会实践，最近使用虚拟机搭建了达梦实时主备集群，并进行实时主备数据同步、切换主备库的验证。特此做总结，包括：集群搭建、监视器、服务名、实时同步数据验证、手动主备切换与验证。\n">
<meta name="keywords" content="达梦, DM, 数据库, 主备集群, 数据库安装"><title>主备集群 达梦实时主备集群搭建与主备切换实践（二）</title>

<link rel='canonical' href='http://localhost:1313/posts/2024/07/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5%E4%BA%8C/'>

<link rel="stylesheet" href="/scss/style.min.0e91ddc078dc4644ec4ec4682d50203275b3e0e9aa37379162c31686c778c042.css"><meta property='og:title' content="主备集群 达梦实时主备集群搭建与主备切换实践（二）">
<meta property='og:description' content="因为之前实施部署达梦数据库，通常是只部署开发环境、测试环境，生成环境的数据库并没有实践在项目中实践过，受限于工作项目，开发、测试环境通常只有一台数据库服务器，部署的单机版。\n对于集群版本一直没有机会实践，最近使用虚拟机搭建了达梦实时主备集群，并进行实时主备数据同步、切换主备库的验证。特此做总结，包括：集群搭建、监视器、服务名、实时同步数据验证、手动主备切换与验证。\n">
<meta property='og:url' content='http://localhost:1313/posts/2024/07/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5%E4%BA%8C/'>
<meta property='og:site_name' content='阿琦同学'>
<meta property='og:type' content='article'><meta property='article:section' content='Posts' /><meta property='article:tag' content='信创' /><meta property='article:tag' content='达梦' /><meta property='article:published_time' content='2024-07-21T22:10:12&#43;08:00'/><meta property='article:modified_time' content='2024-10-14T22:36:23&#43;08:00'/>
<meta name="twitter:title" content="主备集群 达梦实时主备集群搭建与主备切换实践（二）">
<meta name="twitter:description" content="因为之前实施部署达梦数据库，通常是只部署开发环境、测试环境，生成环境的数据库并没有实践在项目中实践过，受限于工作项目，开发、测试环境通常只有一台数据库服务器，部署的单机版。\n对于集群版本一直没有机会实践，最近使用虚拟机搭建了达梦实时主备集群，并进行实时主备数据同步、切换主备库的验证。特此做总结，包括：集群搭建、监视器、服务名、实时同步数据验证、手动主备切换与验证。\n">
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    <img src="/img/tx.png" width="300" height="300" class="site-logo" loading="lazy" alt="Avatar">
                
                </a>
                
                    <span class="emoji">🍥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">阿琦同学</a></h1>
            <h2 class="site-description">Life is Passion !</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/weiqifun'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>文章</span>
            </a>
        </li>
        
        
        <li >
            <a href='/tags/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11 3L20 12a1.5 1.5 0 0 1 0 2L14 20a1.5 1.5 0 0 1 -2 0L3 11v-4a4 4 0 0 1 4 -4h4" />
  <circle cx="9" cy="9" r="2" />
</svg>



                
                <span>标签</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%8F%8B%E9%93%BE/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>友链</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#安装前准备说明">安装前准备说明</a></li>
    <li><a href="#集群规划">集群规划</a>
      <ol>
        <li><a href="#部署信息">部署信息</a></li>
        <li><a href="#切换模式">切换模式</a></li>
      </ol>
    </li>
    <li><a href="#集群搭建">集群搭建</a>
      <ol>
        <li><a href="#安装数据库">安装数据库</a></li>
        <li><a href="#配置-a-机器">配置 A 机器</a>
          <ol>
            <li><a href="#1启动实例服务">1）启动实例服务</a></li>
            <li><a href="#2开启归档">2）开启归档</a></li>
            <li><a href="#3备份数据">3）备份数据</a></li>
            <li><a href="#4修改-dmini">4）修改 dm.ini</a></li>
            <li><a href="#5退出并关闭数据库服务">5）退出并关闭数据库服务</a></li>
            <li><a href="#6修改-dmarchini">6）修改 dmarch.ini</a></li>
            <li><a href="#7创建-dmmalini">7）创建 dmmal.ini</a></li>
            <li><a href="#8创建-dmwatcherini">8）创建 dmwatcher.ini</a></li>
            <li><a href="#9拷贝备份文件到备库">9）拷贝备份文件到备库</a></li>
            <li><a href="#10注册服务">10）注册服务</a>
              <ol>
                <li><a href="#如果需要删除服务">如果需要删除服务</a></li>
              </ol>
            </li>
          </ol>
        </li>
        <li><a href="#配置-b-机器">配置 B 机器</a>
          <ol>
            <li><a href="#1备库恢复数据">1）备库恢复数据</a></li>
            <li><a href="#2创建-dmarchini">2）创建 dmarch.ini</a></li>
            <li><a href="#3修改-dmini">3）修改 dm.ini</a></li>
            <li><a href="#4创建-dmmalini">4）创建 dmmal.ini</a></li>
            <li><a href="#5创建-dmwatcherini">5）创建 dmwatcher.ini</a></li>
            <li><a href="#6注册服务">6）注册服务</a>
              <ol>
                <li></li>
              </ol>
            </li>
          </ol>
        </li>
        <li><a href="#监视器">监视器</a>
          <ol>
            <li><a href="#需要监视器的说明">需要监视器的说明</a></li>
            <li><a href="#1创建-dmmonitorini">1）创建 dmmonitor.ini</a></li>
            <li><a href="#2创建-dmmonitor_manualini">2）创建 dmmonitor_manual.ini</a></li>
            <li><a href="#3注册监视器服务">3）注册监视器服务</a>
              <ol>
                <li><a href="#附删除监视器服务">附：删除监视器服务</a></li>
              </ol>
            </li>
            <li><a href="#4监视器启动">4）监视器启动</a></li>
            <li><a href="#5非确认监视器的使用">5）非确认监视器的使用</a>
              <ol>
                <li><a href="#51进入非确认监视器">5.1）进入非确认监视器</a></li>
                <li><a href="#52监视器命令">5.2）监视器命令</a></li>
              </ol>
            </li>
          </ol>
        </li>
        <li><a href="#启动服务">启动服务</a>
          <ol>
            <li><a href="#启动数据库并修改参数">启动数据库并修改参数</a></li>
            <li><a href="#启动守护进程">启动守护进程</a></li>
          </ol>
        </li>
        <li><a href="#附集群启停">附：集群启停</a></li>
      </ol>
    </li>
    <li><a href="#配置-dm_svcconf">配置 dm_svc.conf</a>
      <ol>
        <li><a href="#实时主备服务名配置">实时主备服务名配置</a></li>
        <li><a href="#jdbc-连接">JDBC 连接</a></li>
        <li><a href="#达梦管理工具连接">达梦管理工具连接</a></li>
        <li><a href="#验证-主库挂掉后是否会自动切换">验证-主库挂掉后是否会自动切换</a>
          <ol>
            <li><a href="#1停止主库">1）停止主库</a></li>
            <li><a href="#2重启主库">2）重启主库</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#验证实时同步">验证实时同步</a>
      <ol>
        <li><a href="#验证一主库操作">验证一：主库操作</a>
          <ol>
            <li><a href="#1执行创建表空间用户授权等操作">1）执行创建表空间、用户、授权等操作</a></li>
            <li><a href="#2创建表插入数据操作">2）创建表、插入数据操作</a></li>
          </ol>
        </li>
        <li><a href="#验证二备库写操作">验证二：备库写操作</a></li>
      </ol>
    </li>
    <li><a href="#无监视器进行主备切换">无监视器进行主备切换</a>
      <ol>
        <li>
          <ol>
            <li><a href="#注意-1">【注意】</a></li>
          </ol>
        </li>
        <li><a href="#a-机器操作主库操作">A 机器操作（主库操作）</a></li>
        <li><a href="#b-机器操作备库操作">B 机器操作（备库操作）</a></li>
        <li><a href="#启动数据守护">启动数据守护</a></li>
        <li><a href="#验证切换是否成功">验证切换是否成功</a>
          <ol>
            <li><a href="#查看实例的模式">查看实例的模式</a></li>
            <li><a href="#在主库操作">在主库操作</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#确认监视器自动切换验证">确认监视器自动切换验证</a></li>
    <li><a href="#非确认监视器切换">非确认监视器切换</a></li>
    <li><a href="#报错问题">报错问题</a>
      <ol>
        <li><a href="#启动数据守护报错">启动数据守护报错</a></li>
        <li><a href="#启动数据库实例报错">启动数据库实例报错</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/%E5%AE%9E%E6%96%BD/" >
                实施
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/posts/2024/07/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5%E4%BA%8C/">主备集群 达梦实时主备集群搭建与主备切换实践（二）</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2024年7月21号</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    阅读时长: 22 分钟
                </time>
            </div>
        

        
        
        <footer class="article-wordcount">
            <div>
                <span class="article-wordcount--count">字数: 10575</span>
            </div>
        </footer>
        
        

    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p>因为之前实施部署达梦数据库，通常是只部署开发环境、测试环境，生成环境的数据库并没有实践在项目中实践过，受限于工作项目，开发、测试环境通常只有一台数据库服务器，部署的单机版。</p>
<p>对于集群版本一直没有机会实践，最近使用虚拟机搭建了达梦实时主备集群，并进行实时主备数据同步、切换主备库的验证。特此做总结，包括：集群搭建、监视器、服务名、实时同步数据验证、手动主备切换与验证。</p>
<h2 id="安装前准备说明">安装前准备说明
</h2><p>1.需要 linux 里有 <code>tar</code> 命令包，执行下边命令验证</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">tar --version
</span></span></code></pre></td></tr></table>
</div>
</div><p>2.需要先将服务器同步时间，一般同步 ntp 服务器，也可以手动修改</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">date -s <span class="s2">&#34;yyyy-mm-dd HH:MM:SS&#34;</span>
</span></span><span class="line"><span class="cl">date -s
</span></span></code></pre></td></tr></table>
</div>
</div><p>3.关闭防火墙并禁止自启</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">systemctl stop firewalld
</span></span><span class="line"><span class="cl">systemctl disable firewalld
</span></span></code></pre></td></tr></table>
</div>
</div><p>4.确保主备服务器网络互通，避免同步数据失效，需要互相传 Redo 日志的</p>
<p>5.达梦数据库官方是建议关闭 SWAP 分区的，内存充足也可不关</p>
<p>6.调整 limit.sconf 参数</p>
<h2 id="集群规划">集群规划
</h2><p>需要注意的是，确认端口不会与其他服务进程冲突</p>
<h3 id="部署信息">部署信息
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th style="text-align: left"></th>
          <th style="text-align: left">A机器</th>
          <th style="text-align: left">B机器</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">IP</td>
          <td style="text-align: left">192.168.163.9</td>
          <td style="text-align: left">192.168.163.10</td>
      </tr>
      <tr>
          <td style="text-align: left">实例名</td>
          <td style="text-align: left">GRP_TEST_01</td>
          <td style="text-align: left">GRP_TEST_02</td>
      </tr>
      <tr>
          <td style="text-align: left">实例端口</td>
          <td style="text-align: left">5236</td>
          <td style="text-align: left">5236</td>
      </tr>
      <tr>
          <td style="text-align: left">守护进程端口</td>
          <td style="text-align: left">5536</td>
          <td style="text-align: left">5536</td>
      </tr>
      <tr>
          <td style="text-align: left">MAL端口</td>
          <td style="text-align: left">5336</td>
          <td style="text-align: left">5336</td>
      </tr>
      <tr>
          <td style="text-align: left">守护组</td>
          <td style="text-align: left">GRP1</td>
          <td style="text-align: left">GPR1</td>
      </tr>
      <tr>
          <td style="text-align: left">安装目录</td>
          <td style="text-align: left">/home/dmdba/dmdbms</td>
          <td style="text-align: left">/home/dmdba/dmdbms</td>
      </tr>
      <tr>
          <td style="text-align: left">实例目录</td>
          <td style="text-align: left">/home/dmdba/data</td>
          <td style="text-align: left">/home/dmdba/data</td>
      </tr>
      <tr>
          <td style="text-align: left">归档上限</td>
          <td style="text-align: left">10240（生产一般不设上限，由DBA规划）</td>
          <td style="text-align: left">10240</td>
      </tr>
  </tbody>
</table></div>
<h3 id="切换模式">切换模式
</h3><p>需要考虑 <code>ALTER_MODE_STATUS</code> 参数是多少：0-不可修改，1-可修改</p>
<h2 id="集群搭建">集群搭建
</h2><h3 id="安装数据库">安装数据库
</h3><p>步骤可参照 <a class="link" href="https://weiqifun.github.io/2024/06/06/%e5%ae%9e%e6%96%bd%e9%83%a8%e7%bd%b2-%e8%be%be%e6%a2%a6%e6%95%b0%e6%8d%ae%e5%ba%93%e7%9a%84%e5%ae%89%e8%a3%85/"  target="_blank" rel="noopener"
    >实施部署-达梦数据库linux版的安装（二） | WeiQi Blog (weiqifun.github.io)</a></p>
<p>按照下边也可以，总之步骤需要到初始化实例</p>
<p>搭建集群时，每台都需要初始化实例（即 192.168.163.9 和 192.168.163.10 都需要）</p>
<p><strong>注意：在使用</strong> <code>./dminit</code> <strong>初始化实例时，请注意修改实例名：</strong></p>
<p><strong>192.168.163.9 &gt; GRP_TEST_01</strong></p>
<p><strong>192.168.163.10 &gt; GRP_TEST_02</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@linux1 soft<span class="o">]</span><span class="c1"># groupadd dinstall</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@linux1 soft<span class="o">]</span><span class="c1"># useradd -g dinstall -m -d /home/dmdba -s /bin/bash dmdba</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@linux1 soft<span class="o">]</span><span class="c1"># passwd dmdba</span>
</span></span><span class="line"><span class="cl">更改用户 dmdba 的密码 。
</span></span><span class="line"><span class="cl">新的 密码：!@#<span class="nv">$qwer</span>
</span></span><span class="line"><span class="cl">重新输入新的 密码：!@#<span class="nv">$qwer</span>
</span></span><span class="line"><span class="cl">passwd：所有的身份验证令牌已经成功更新。
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@linux1 soft<span class="o">]</span><span class="c1"># vi /etc/security/limits.conf</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 在conf文件内容的最后添加</span>
</span></span><span class="line"><span class="cl">dmdba hard nofile <span class="m">65536</span>
</span></span><span class="line"><span class="cl">dmdba soft nofile <span class="m">65536</span>
</span></span><span class="line"><span class="cl">dmdba hard stack <span class="m">32768</span>
</span></span><span class="line"><span class="cl">dmdba soft stack <span class="m">16384</span>
</span></span><span class="line"><span class="cl"><span class="c1"># :wq 保存</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@linux1 soft<span class="o">]</span><span class="c1"># su - dmdba</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux1 ~<span class="o">]</span>$ <span class="nb">ulimit</span> -a
</span></span><span class="line"><span class="cl">core file size          <span class="o">(</span>blocks, -c<span class="o">)</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">data seg size           <span class="o">(</span>kbytes, -d<span class="o">)</span> unlimited
</span></span><span class="line"><span class="cl">scheduling priority             <span class="o">(</span>-e<span class="o">)</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">file size               <span class="o">(</span>blocks, -f<span class="o">)</span> unlimited
</span></span><span class="line"><span class="cl">pending signals                 <span class="o">(</span>-i<span class="o">)</span> <span class="m">14989</span>
</span></span><span class="line"><span class="cl">max locked memory       <span class="o">(</span>kbytes, -l<span class="o">)</span> <span class="m">64</span>
</span></span><span class="line"><span class="cl">max memory size         <span class="o">(</span>kbytes, -m<span class="o">)</span> unlimited
</span></span><span class="line"><span class="cl">open files                      <span class="o">(</span>-n<span class="o">)</span> <span class="m">65536</span>
</span></span><span class="line"><span class="cl">pipe size            <span class="o">(</span><span class="m">512</span> bytes, -p<span class="o">)</span> <span class="m">8</span>
</span></span><span class="line"><span class="cl">POSIX message queues     <span class="o">(</span>bytes, -q<span class="o">)</span> <span class="m">819200</span>
</span></span><span class="line"><span class="cl">real-time priority              <span class="o">(</span>-r<span class="o">)</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">stack size              <span class="o">(</span>kbytes, -s<span class="o">)</span> <span class="m">16384</span>
</span></span><span class="line"><span class="cl">cpu <span class="nb">time</span>               <span class="o">(</span>seconds, -t<span class="o">)</span> unlimited
</span></span><span class="line"><span class="cl">max user processes              <span class="o">(</span>-u<span class="o">)</span> <span class="m">4096</span>
</span></span><span class="line"><span class="cl">virtual memory          <span class="o">(</span>kbytes, -v<span class="o">)</span> unlimited
</span></span><span class="line"><span class="cl">file locks                      <span class="o">(</span>-x<span class="o">)</span> unlimited
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@linux1 soft<span class="o">]</span><span class="c1"># chmod 755 dm8_20240408_x86_rh7_64.iso</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@linux1 soft<span class="o">]</span><span class="c1"># mount -o loop dm8_20240408_x86_rh7_64.iso /mnt/</span>
</span></span><span class="line"><span class="cl">mount: /dev/loop0 写保护，将以只读方式挂载
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@linux1 soft<span class="o">]</span><span class="c1"># su - dmdba</span>
</span></span><span class="line"><span class="cl">上一次登录：六 7月 <span class="m">20</span> 23:55:52 CST 2024pts/0 上
</span></span><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux1 ~<span class="o">]</span>$ <span class="nb">cd</span> /mnt/
</span></span><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux1 mnt<span class="o">]</span>$ ll
</span></span><span class="line"><span class="cl">总用量 <span class="m">1057031</span>
</span></span><span class="line"><span class="cl">-r-xr-xr-x. <span class="m">1</span> root root    <span class="m">2587699</span> 3月  <span class="m">20</span> 14:04 DM8 Install.pdf
</span></span><span class="line"><span class="cl">-r-xr-xr-x. <span class="m">1</span> root root <span class="m">1079810877</span> 4月   <span class="m">8</span> 13:35 DMInstall.bin
</span></span><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux1 mnt<span class="o">]</span>$ ./DMInstall.bin -i
</span></span><span class="line"><span class="cl">安装语言:
</span></span><span class="line"><span class="cl"><span class="o">[</span>1<span class="o">]</span>: 简体中文
</span></span><span class="line"><span class="cl"><span class="o">[</span>2<span class="o">]</span>: English
</span></span><span class="line"><span class="cl">请选择安装语言 <span class="o">[</span>1<span class="o">]</span>:1
</span></span><span class="line"><span class="cl">解压安装程序.........
</span></span><span class="line"><span class="cl">欢迎使用达梦数据库安装程序
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">是否输入Key文件路径? <span class="o">(</span>Y/y:是 N/n:否<span class="o">)</span> <span class="o">[</span>Y/y<span class="o">]</span>:n
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">是否设置时区? <span class="o">(</span>Y/y:是 N/n:否<span class="o">)</span> <span class="o">[</span>Y/y<span class="o">]</span>:y
</span></span><span class="line"><span class="cl">设置时区:
</span></span><span class="line"><span class="cl"><span class="o">[</span> 1<span class="o">]</span>: <span class="o">(</span>GTM-12:00<span class="o">)</span> 日界线西
</span></span><span class="line"><span class="cl"><span class="o">[</span> 2<span class="o">]</span>: <span class="o">(</span>GTM-11:00<span class="o">)</span> 萨摩亚群岛
</span></span><span class="line"><span class="cl"><span class="o">[</span> 3<span class="o">]</span>: <span class="o">(</span>GTM-10:00<span class="o">)</span> 夏威夷
</span></span><span class="line"><span class="cl"><span class="o">[</span> 4<span class="o">]</span>: <span class="o">(</span>GTM-09:00<span class="o">)</span> 阿拉斯加
</span></span><span class="line"><span class="cl"><span class="o">[</span> 5<span class="o">]</span>: <span class="o">(</span>GTM-08:00<span class="o">)</span> 太平洋时间（美国和加拿大）
</span></span><span class="line"><span class="cl"><span class="o">[</span> 6<span class="o">]</span>: <span class="o">(</span>GTM-07:00<span class="o">)</span> 亚利桑那
</span></span><span class="line"><span class="cl"><span class="o">[</span> 7<span class="o">]</span>: <span class="o">(</span>GTM-06:00<span class="o">)</span> 中部时间（美国和加拿大）
</span></span><span class="line"><span class="cl"><span class="o">[</span> 8<span class="o">]</span>: <span class="o">(</span>GTM-05:00<span class="o">)</span> 东部部时间（美国和加拿大）
</span></span><span class="line"><span class="cl"><span class="o">[</span> 9<span class="o">]</span>: <span class="o">(</span>GTM-04:00<span class="o">)</span> 大西洋时间（美国和加拿大）
</span></span><span class="line"><span class="cl"><span class="o">[</span>10<span class="o">]</span>: <span class="o">(</span>GTM-03:00<span class="o">)</span> 巴西利亚
</span></span><span class="line"><span class="cl"><span class="o">[</span>11<span class="o">]</span>: <span class="o">(</span>GTM-02:00<span class="o">)</span> 中大西洋
</span></span><span class="line"><span class="cl"><span class="o">[</span>12<span class="o">]</span>: <span class="o">(</span>GTM-01:00<span class="o">)</span> 亚速尔群岛
</span></span><span class="line"><span class="cl"><span class="o">[</span>13<span class="o">]</span>: <span class="o">(</span>GTM<span class="o">)</span> 格林威治标准时间
</span></span><span class="line"><span class="cl"><span class="o">[</span>14<span class="o">]</span>: <span class="o">(</span>GTM+01:00<span class="o">)</span> 萨拉热窝
</span></span><span class="line"><span class="cl"><span class="o">[</span>15<span class="o">]</span>: <span class="o">(</span>GTM+02:00<span class="o">)</span> 开罗
</span></span><span class="line"><span class="cl"><span class="o">[</span>16<span class="o">]</span>: <span class="o">(</span>GTM+03:00<span class="o">)</span> 莫斯科
</span></span><span class="line"><span class="cl"><span class="o">[</span>17<span class="o">]</span>: <span class="o">(</span>GTM+04:00<span class="o">)</span> 阿布扎比
</span></span><span class="line"><span class="cl"><span class="o">[</span>18<span class="o">]</span>: <span class="o">(</span>GTM+05:00<span class="o">)</span> 伊斯兰堡
</span></span><span class="line"><span class="cl"><span class="o">[</span>19<span class="o">]</span>: <span class="o">(</span>GTM+06:00<span class="o">)</span> 达卡
</span></span><span class="line"><span class="cl"><span class="o">[</span>20<span class="o">]</span>: <span class="o">(</span>GTM+07:00<span class="o">)</span> 曼谷，河内
</span></span><span class="line"><span class="cl"><span class="o">[</span>21<span class="o">]</span>: <span class="o">(</span>GTM+08:00<span class="o">)</span> 中国标准时间
</span></span><span class="line"><span class="cl"><span class="o">[</span>22<span class="o">]</span>: <span class="o">(</span>GTM+09:00<span class="o">)</span> 首尔
</span></span><span class="line"><span class="cl"><span class="o">[</span>23<span class="o">]</span>: <span class="o">(</span>GTM+10:00<span class="o">)</span> 关岛
</span></span><span class="line"><span class="cl"><span class="o">[</span>24<span class="o">]</span>: <span class="o">(</span>GTM+11:00<span class="o">)</span> 所罗门群岛
</span></span><span class="line"><span class="cl"><span class="o">[</span>25<span class="o">]</span>: <span class="o">(</span>GTM+12:00<span class="o">)</span> 斐济
</span></span><span class="line"><span class="cl"><span class="o">[</span>26<span class="o">]</span>: <span class="o">(</span>GTM+13:00<span class="o">)</span> 努库阿勒法
</span></span><span class="line"><span class="cl"><span class="o">[</span>27<span class="o">]</span>: <span class="o">(</span>GTM+14:00<span class="o">)</span> 基里巴斯
</span></span><span class="line"><span class="cl">请选择时区 <span class="o">[</span>21<span class="o">]</span>:21
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">安装类型:
</span></span><span class="line"><span class="cl"><span class="m">1</span> 典型安装
</span></span><span class="line"><span class="cl"><span class="m">2</span> 服务器
</span></span><span class="line"><span class="cl"><span class="m">3</span> 客户端
</span></span><span class="line"><span class="cl"><span class="m">4</span> 自定义
</span></span><span class="line"><span class="cl">请选择安装类型的数字序号 <span class="o">[</span><span class="m">1</span> 典型安装<span class="o">]</span>:1
</span></span><span class="line"><span class="cl">所需空间: 2310M
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">请选择安装目录 <span class="o">[</span>/home/dmdba/dmdbms<span class="o">]</span>:
</span></span><span class="line"><span class="cl">可用空间: 29G
</span></span><span class="line"><span class="cl">是否确认安装路径<span class="o">(</span>/home/dmdba/dmdbms<span class="o">)</span>? <span class="o">(</span>Y/y:是 N/n:否<span class="o">)</span>  <span class="o">[</span>Y/y<span class="o">]</span>:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">安装前小结
</span></span><span class="line"><span class="cl">安装位置: /home/dmdba/dmdbms
</span></span><span class="line"><span class="cl">所需空间: 2310M
</span></span><span class="line"><span class="cl">可用空间: 29G
</span></span><span class="line"><span class="cl">版本信息:
</span></span><span class="line"><span class="cl">有效日期:
</span></span><span class="line"><span class="cl">安装类型: 典型安装
</span></span><span class="line"><span class="cl">是否确认安装? <span class="o">(</span>Y/y:是 N/n:否<span class="o">)</span>:y
</span></span><span class="line"><span class="cl">2024-07-21 00:02:02
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span> 安装达梦数据库...
</span></span><span class="line"><span class="cl">2024-07-21 00:02:02
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span> 安装 基础 模块...
</span></span><span class="line"><span class="cl">2024-07-21 00:02:13
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span> 安装 服务器 模块...
</span></span><span class="line"><span class="cl">2024-07-21 00:02:17
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span> 安装 客户端 模块...
</span></span><span class="line"><span class="cl">2024-07-21 00:02:23
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span> 安装 驱动 模块...
</span></span><span class="line"><span class="cl">2024-07-21 00:02:27
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span> 安装 手册 模块...
</span></span><span class="line"><span class="cl">2024-07-21 00:02:28
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span> 安装 服务 模块...
</span></span><span class="line"><span class="cl">2024-07-21 00:02:28
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span> 移动日志文件。
</span></span><span class="line"><span class="cl">2024-07-21 00:02:29
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span> 安装达梦数据库完成。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">请以root系统用户执行命令:
</span></span><span class="line"><span class="cl">/home/dmdba/dmdbms/script/root/root_installer.sh
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">安装结束
</span></span><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux1 mnt<span class="o">]</span>$ su - root
</span></span><span class="line"><span class="cl">密码：
</span></span><span class="line"><span class="cl">上一次登录：六 7月 <span class="m">20</span> 23:57:11 CST 2024pts/0 上
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@linux1 ~<span class="o">]</span><span class="c1"># /home/dmdba/dmdbms/script/root/root_installer.sh</span>
</span></span><span class="line"><span class="cl">移动 /home/dmdba/dmdbms/bin/dm_svc.conf 到/etc目录
</span></span><span class="line"><span class="cl">创建DmAPService服务
</span></span><span class="line"><span class="cl">Created symlink from /etc/systemd/system/multi-user.target.wants/DmAPService.service to /usr/lib/systemd/system/DmAPService.service.
</span></span><span class="line"><span class="cl">创建服务<span class="o">(</span>DmAPService<span class="o">)</span>完成
</span></span><span class="line"><span class="cl">启动DmAPService服务
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@linux1 ~<span class="o">]</span><span class="c1"># su - dmdba</span>
</span></span><span class="line"><span class="cl">上一次登录：日 7月 <span class="m">21</span> 00:00:02 CST 2024pts/0 上
</span></span><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux1 ~<span class="o">]</span>$ <span class="nb">cd</span> /home/dmdba/dmdbms/bin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">##########################################################</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ./dminit 这个步骤要注意，实例名要有区分</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ./dminit 参数详见 https://eco.dameng.com/document/dm/zh-cn/pm/dminit-parameters.html</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 如果需要将数据文件放到其他地方，则 path 参数应为具体的路径</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 例如：path=/home/dmdba/data （提前建好）</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 如果数据库名自定义，则 DM_NAME 参数应为自定义名称</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 例如：DB_NAME=TEST_DB</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 这样创建好的数据文件路径，则为：/home/dmdba/data/TEST_DB</span>
</span></span><span class="line"><span class="cl"><span class="c1">##########################################################</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux1 bin<span class="o">]</span><span class="c1"># ./dminit path=/home/dmdba/dmdbms PAGE_SIZE=32 EXTENT_SIZE=32 CASE_SENSITIVE=y CHARSET=0 DB_NAME=DMDB INSTANCE_NAME=GRP_TEST_01 PORT_NUM=5236</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">initdb V8
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">db version: 0x7000c
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">file dm.key not found, use default license!
</span></span><span class="line"><span class="cl">License will expire on 2025-03-21
</span></span><span class="line"><span class="cl">Normal of FAST
</span></span><span class="line"><span class="cl">Normal of DEFAULT
</span></span><span class="line"><span class="cl">Normal of RECYCLE
</span></span><span class="line"><span class="cl">Normal of KEEP
</span></span><span class="line"><span class="cl">Normal of ROLL
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> log file path: /home/dmdba/dmdbms/DMDB/DMDB01.log
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> log file path: /home/dmdba/dmdbms/DMDB/DMDB02.log
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">write to dir <span class="o">[</span>/home/dmdba/dmdbms/DMDB<span class="o">]</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">create dm database success. 2024-07-21 00:06:03
</span></span></code></pre></td></tr></table>
</div>
</div><p>到这里，初始化实例完成！</p>
<h3 id="配置-a-机器">配置 A 机器
</h3><p>把 192.168.163.9 作为主库，即所谓的 A 机器</p>
<p><strong>以下步骤非必要说明，均使用数据库用户</strong> <code>dmdba</code> <strong>操作</strong></p>
<p>先把 A 机器的数据库服务启动</p>
<h4 id="1启动实例服务">1）启动实例服务
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 前台启动服务</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux1 ~<span class="o">]</span>$ <span class="nb">cd</span> /home/dmdba/dmdbms/bin
</span></span><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux1 bin<span class="o">]</span>$ ./dmserver /home/dmdba/dmdbms/DMDB/dm.ini
</span></span></code></pre></td></tr></table>
</div>
</div><p>因为还没有在 <code>../script/root</code> 执行创建服务的命令，所以现在是没有后台启动服务的命令的</p>
<h4 id="2开启归档">2）开启归档
</h4><p>SPACE_LIMIT 是归档空间的最大限制，空间不足时，会将之前旧的归档文件删掉</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux1 bin<span class="o">]</span>$ ./disql SYSDBA/SYSDBA
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">服务器<span class="o">[</span>LOCALHOST:5236<span class="o">]</span>:处于普通打开状态
</span></span><span class="line"><span class="cl">登录使用时间 : 17.680<span class="o">(</span>ms<span class="o">)</span>
</span></span><span class="line"><span class="cl">disql V8
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SQL&gt; ALTER DATABASE MOUNT<span class="p">;</span>
</span></span><span class="line"><span class="cl">操作已执行
</span></span><span class="line"><span class="cl">已用时间: 3.546<span class="o">(</span>毫秒<span class="o">)</span>. 执行号:0.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SQL&gt; ALTER DATABASE ARCHIVELOG<span class="p">;</span>
</span></span><span class="line"><span class="cl">操作已执行
</span></span><span class="line"><span class="cl">已用时间: 17.101<span class="o">(</span>毫秒<span class="o">)</span>. 执行号:0.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SQL&gt; ALTER DATABASE ADD ARCHIVELOG <span class="s1">&#39;DEST=/home/dmdba/dmdbms/DMDB/arch, TYPE=LOCAL, FILE_SIZE=1024, SPACE_LIMIT=10240&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">操作已执行
</span></span><span class="line"><span class="cl">已用时间: 4.701<span class="o">(</span>毫秒<span class="o">)</span>. 执行号:0.
</span></span><span class="line"><span class="cl">SQL&gt; ALTER DATABASE OPEN<span class="p">;</span>
</span></span><span class="line"><span class="cl">操作已执行
</span></span><span class="line"><span class="cl">已用时间: 16.531<span class="o">(</span>毫秒<span class="o">)</span>. 执行号:0.
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3备份数据">3）备份数据
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">SQL&gt; BACKUP DATABASE BACKUPSET <span class="s1">&#39;/home/dmdba/dmdbms/DMDB/bak/BACKUP_FILE&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">操作已执行
</span></span><span class="line"><span class="cl">已用时间: 00:00:08.767. 执行号:501.
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="4修改-dmini">4）修改 dm.ini
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">SQL&gt; SP_SET_PARA_VALUE <span class="o">(</span>2,<span class="s1">&#39;PORT_NUM&#39;</span>,5236<span class="o">)</span><span class="p">;</span> <span class="c1">#数据库实例监听端口</span>
</span></span><span class="line"><span class="cl">SQL&gt; SP_SET_PARA_VALUE <span class="o">(</span>2,<span class="s1">&#39;DW_INACTIVE_INTERVAL&#39;</span>,60<span class="o">)</span><span class="p">;</span> <span class="c1">#接收守护进程消息超时时间</span>
</span></span><span class="line"><span class="cl">SQL&gt; SP_SET_PARA_VALUE <span class="o">(</span>2,<span class="s1">&#39;ALTER_MODE_STATUS&#39;</span>,0<span class="o">)</span><span class="p">;</span>  <span class="c1">#不允许手工方式修改实例模式/状态/OGUID</span>
</span></span><span class="line"><span class="cl">SQL&gt; SP_SET_PARA_VALUE <span class="o">(</span>2,<span class="s1">&#39;ENABLE_OFFLINE_TS&#39;</span>,2<span class="o">)</span><span class="p">;</span>  <span class="c1">#不允许备库 OFFLINE 表空间</span>
</span></span><span class="line"><span class="cl">SQL&gt; SP_SET_PARA_VALUE <span class="o">(</span>2,<span class="s1">&#39;MAL_INI&#39;</span>,1<span class="o">)</span><span class="p">;</span>     <span class="c1">#打开 MAL 系统</span>
</span></span><span class="line"><span class="cl">SQL&gt; SP_SET_PARA_VALUE <span class="o">(</span>2,<span class="s1">&#39;RLOG_SEND_APPLY_MON&#39;</span>,64<span class="o">)</span><span class="p">;</span>    <span class="c1">#统计最近 64 次的日志重演信息</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="5退出并关闭数据库服务">5）退出并关闭数据库服务
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">SQL&gt; exit<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 到开启服务的linux窗口，终止前台服务</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="6修改-dmarchini">6）修改 dmarch.ini
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux1~<span class="o">]</span>$ vi /home/dmdba/dmdbms/DMDB/dmarch.ini
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">ARCH_WAIT_APPLY</span>            <span class="o">=</span> <span class="m">0</span>   <span class="c1">#0：高性能 1：事务一致</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>ARCHIVE_LOCAL<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">ARCH_TYPE</span>                <span class="o">=</span> LOCAL  <span class="c1">#本地归档类型</span>
</span></span><span class="line"><span class="cl"><span class="nv">ARCH_DEST</span>                <span class="o">=</span> /home/dmdba/dmdbms/DMDB/arch/  <span class="c1">#本地归档存放路径</span>
</span></span><span class="line"><span class="cl"><span class="nv">ARCH_FILE_SIZE</span>           <span class="o">=</span> <span class="m">1024</span>  <span class="c1">#单个归档大小，单位 MB</span>
</span></span><span class="line"><span class="cl"><span class="nv">ARCH_SPACE_LIMIT</span>         <span class="o">=</span> <span class="m">10240</span>  <span class="c1">#归档上限，单位 MB</span>
</span></span><span class="line"><span class="cl"><span class="nv">ARCH_FLUSH_BUF_SIZE</span>      <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="nv">ARCH_HANG_FLAG</span>           <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>ARCHIVE_REALTIME1<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">ARCH_TYPE</span>                <span class="o">=</span> REALTIME  <span class="c1">#实时归档类型</span>
</span></span><span class="line"><span class="cl"><span class="nv">ARCH_DEST</span>                <span class="o">=</span> GRP_TEST_02  <span class="c1">#实时归档目标实例名(备库实例名)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="7创建-dmmalini">7）创建 dmmal.ini
</h4><p>在 <code>dm.ini</code> 相同目录下，创建 <code>dmmal.ini</code></p>
<p>是两个机器传 Redo 日志、响应消息的配置文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">vi /home/dmdba/dmdbms/DMDB/dmmal.ini
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">MAL_CHECK_INTERVAL</span>         <span class="o">=</span> <span class="m">10</span>  <span class="c1">#MAL 链路检测时间间隔</span>
</span></span><span class="line"><span class="cl"><span class="nv">MAL_CONN_FAIL_INTERVAL</span>     <span class="o">=</span> <span class="m">10</span>  <span class="c1">#判定 MAL 链路断开的时间</span>
</span></span><span class="line"><span class="cl"><span class="nv">MAL_TEMP_PATH</span>              <span class="o">=</span> /home/dmdba/dmdbms/DMDB/malpath/  <span class="c1">#临时文件目录</span>
</span></span><span class="line"><span class="cl"><span class="nv">MAL_BUF_SIZE</span>               <span class="o">=</span> <span class="m">512</span>  <span class="c1">#单个 MAL 缓存大小，单位 MB</span>
</span></span><span class="line"><span class="cl"><span class="nv">MAL_SYS_BUF_SIZE</span>           <span class="o">=</span> <span class="m">2048</span>  <span class="c1">#MAL 总大小限制，单位 MB</span>
</span></span><span class="line"><span class="cl"><span class="nv">MAL_COMPRESS_LEVEL</span>         <span class="o">=</span> <span class="m">0</span>  <span class="c1">#MAL 消息压缩等级，0 表示不压缩</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>MAL_INST1<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">MAL_INST_NAME</span>            <span class="o">=</span> GRP_TEST_01  <span class="c1">#实例名，和 dm.ini 的 INSTANCE_NAME 一致</span>
</span></span><span class="line"><span class="cl"><span class="nv">MAL_HOST</span>                 <span class="o">=</span> 192.168.163.9  <span class="c1">#MAL 系统监听 TCP 连接的 IP 地址</span>
</span></span><span class="line"><span class="cl"><span class="nv">MAL_PORT</span>                 <span class="o">=</span> <span class="m">5336</span>  <span class="c1">#MAL 系统监听 TCP 连接的端口</span>
</span></span><span class="line"><span class="cl"><span class="nv">MAL_INST_HOST</span>            <span class="o">=</span> 192.168.163.9  <span class="c1">#实例的对外服务 IP 地址</span>
</span></span><span class="line"><span class="cl"><span class="nv">MAL_INST_PORT</span>            <span class="o">=</span> <span class="m">5236</span>  <span class="c1">#实例对外服务端口，和 dm.ini 的 PORT_NUM 一致</span>
</span></span><span class="line"><span class="cl"><span class="nv">MAL_DW_PORT</span>              <span class="o">=</span> <span class="m">5436</span>  <span class="c1">#实例对应的守护进程监听 TCP 连接的端口</span>
</span></span><span class="line"><span class="cl"><span class="nv">MAL_INST_DW_PORT</span>         <span class="o">=</span> <span class="m">5536</span>  <span class="c1">#实例监听守护进程 TCP 连接的端口</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>MAL_INST2<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">MAL_INST_NAME</span>            <span class="o">=</span> GRP_TEST_02
</span></span><span class="line"><span class="cl"><span class="nv">MAL_HOST</span>                 <span class="o">=</span> 192.168.163.10
</span></span><span class="line"><span class="cl"><span class="nv">MAL_PORT</span>                 <span class="o">=</span> <span class="m">5336</span>
</span></span><span class="line"><span class="cl"><span class="nv">MAL_INST_HOST</span>            <span class="o">=</span> 192.168.163.10
</span></span><span class="line"><span class="cl"><span class="nv">MAL_INST_PORT</span>            <span class="o">=</span> <span class="m">5236</span>
</span></span><span class="line"><span class="cl"><span class="nv">MAL_DW_PORT</span>              <span class="o">=</span> <span class="m">5436</span>
</span></span><span class="line"><span class="cl"><span class="nv">MAL_INST_DW_PORT</span>         <span class="o">=</span> <span class="m">5536</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="8创建-dmwatcherini">8）创建 dmwatcher.ini
</h4><p>在 <code>dm.ini</code> 相同目录下，创建 <code>dmwatcher.ini</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>GRP1<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">DW_TYPE</span>                  <span class="o">=</span> GLOBAL  <span class="c1">#全局守护类型</span>
</span></span><span class="line"><span class="cl"><span class="nv">DW_MODE</span>                  <span class="o">=</span> AUTO  <span class="c1">#MANUAL：故障手切 AUTO：故障自切</span>
</span></span><span class="line"><span class="cl"><span class="nv">DW_ERROR_TIME</span>            <span class="o">=</span> <span class="m">20</span>  <span class="c1">#远程守护进程故障认定时间</span>
</span></span><span class="line"><span class="cl"><span class="nv">INST_ERROR_TIME</span>          <span class="o">=</span> <span class="m">20</span>  <span class="c1">#本地实例故障认定时间</span>
</span></span><span class="line"><span class="cl"><span class="nv">INST_RECOVER_TIME</span>        <span class="o">=</span> <span class="m">60</span>  <span class="c1">#主库守护进程启动恢复的间隔时间</span>
</span></span><span class="line"><span class="cl"><span class="nv">INST_OGUID</span>               <span class="o">=</span> <span class="m">45331</span>  <span class="c1">#守护系统唯一 OGUID 值</span>
</span></span><span class="line"><span class="cl"><span class="nv">INST_INI</span>                 <span class="o">=</span> /home/dmdba/dmdbms/DMDB/dm.ini  <span class="c1">#dm.ini 文件路径</span>
</span></span><span class="line"><span class="cl"><span class="nv">INST_AUTO_RESTART</span>        <span class="o">=</span> <span class="m">1</span>  <span class="c1">#打开实例的自动启动功能</span>
</span></span><span class="line"><span class="cl"><span class="nv">INST_STARTUP_CMD</span>         <span class="o">=</span> /home/dmdba/dmdbms/bin/dmserver  <span class="c1">#命令行方式启动</span>
</span></span><span class="line"><span class="cl"><span class="nv">RLOG_SEND_THRESHOLD</span>      <span class="o">=</span> <span class="m">0</span>  <span class="c1">#指定主库发送日志到备库的时间阈值，默认关闭</span>
</span></span><span class="line"><span class="cl"><span class="nv">RLOG_APPLY_THRESHOLD</span>     <span class="o">=</span> <span class="m">0</span>  <span class="c1">#指定备库重演日志的时间阈值，默认关闭</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="9拷贝备份文件到备库">9）拷贝备份文件到备库
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux1 DMDB<span class="o">]</span>$ scp -r /home/dmdba/dmdbms/DMDB/bak/BACKUP_FILE dmdba@192.168.163.10:/home/dmdba/dmdbms/DMDB/bak/
</span></span><span class="line"><span class="cl">The authenticity of host <span class="s1">&#39;192.168.163.10 (192.168.163.10)&#39;</span> can<span class="s1">&#39;t be established.
</span></span></span><span class="line"><span class="cl"><span class="s1">ECDSA key fingerprint is SHA256:xU91rJPNr+WlgJJ3xkHHHdDAo/vxPcgYj7U+VH4zLYg.
</span></span></span><span class="line"><span class="cl"><span class="s1">ECDSA key fingerprint is MD5:1c:b2:a6:11:d1:b8:20:e7:c4:6d:a1:0b:df:2a:d0:1c.
</span></span></span><span class="line"><span class="cl"><span class="s1">Are you sure you want to continue connecting (yes/no)? yes
</span></span></span><span class="line"><span class="cl"><span class="s1">Warning: Permanently added &#39;</span>192.168.163.10<span class="s1">&#39; (ECDSA) to the list of known hosts.
</span></span></span><span class="line"><span class="cl"><span class="s1">dmdba@192.168.163.10&#39;</span>s password:
</span></span><span class="line"><span class="cl">BACKUP_FILE.bak                                                                                                                  100%   27MB  20.5MB/s   00:01
</span></span><span class="line"><span class="cl">BACKUP_FILE.meta
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="10注册服务">10）注册服务
</h4><p><strong>使用</strong> <code>root</code> <strong>用户操作</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@linux1 ~<span class="o">]</span><span class="c1"># cd /home/dmdba/dmdbms/script/root/</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@linux1 root<span class="o">]</span><span class="c1"># ll</span>
</span></span><span class="line"><span class="cl">总用量 <span class="m">44</span>
</span></span><span class="line"><span class="cl">-rwxr-xr-x. <span class="m">1</span> dmdba dinstall <span class="m">25373</span> 7月  <span class="m">21</span> 00:02 dm_service_installer.sh
</span></span><span class="line"><span class="cl">-rwxr-xr-x. <span class="m">1</span> dmdba dinstall  <span class="m">9214</span> 7月  <span class="m">21</span> 00:02 dm_service_uninstaller.sh
</span></span><span class="line"><span class="cl">-rwxr-xr-x. <span class="m">1</span> dmdba dinstall   <span class="m">490</span> 7月  <span class="m">21</span> 00:02 root_installer.sh
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">####################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 创建数据库服务</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -p 实例名</span>
</span></span><span class="line"><span class="cl"><span class="c1">####################</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@linux1 root<span class="o">]</span><span class="c1"># ./dm_service_installer.sh -t dmserver -p GRP_TEST_01 -dm_ini /home/dmdba/dmdbms/DMDB/dm.ini -m mount</span>
</span></span><span class="line"><span class="cl">Created symlink from /etc/systemd/system/multi-user.target.wants/DmServiceGRP_TEST_01.service to /usr/lib/systemd/system/DmServiceGRP_TEST_01.service.
</span></span><span class="line"><span class="cl">创建服务<span class="o">(</span>DmServiceGRP_TEST_01<span class="o">)</span>完成
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">####################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 创建数据守护服务</span>
</span></span><span class="line"><span class="cl"><span class="c1">####################</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@linux1 root<span class="o">]</span><span class="c1"># ./dm_service_installer.sh -t dmwatcher -p Watcher -watcher_ini /home/dmdba/dmdbms/DMDB/dmwatcher.ini</span>
</span></span><span class="line"><span class="cl">Created symlink from /etc/systemd/system/multi-user.target.wants/DmWatcherServiceWatcher.service to /usr/lib/systemd/system/DmWatcherServiceWatcher.service.
</span></span><span class="line"><span class="cl">创建服务<span class="o">(</span>DmWatcherServiceWatcher<span class="o">)</span>完成
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="如果需要删除服务">如果需要删除服务
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@~<span class="o">]</span><span class="c1"># ./dm_service_uninstaller.sh -n DmServiceGRP_TEST_01</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@~<span class="o">]</span><span class="c1"># ./dm_service_uninstaller.sh -n DmWatcherServiceWatcher</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="配置-b-机器">配置 B 机器
</h3><p>192.168.163.10 为备库</p>
<p>因为安装数据库的时候，已经初始化实例了</p>
<p>现在需要做的就是在备库同步主库的数据，让主备保持一致的状态</p>
<h4 id="1备库恢复数据">1）备库恢复数据
</h4><p>执行下边两条，注意 <code>dm.ini</code> 的位置和备份文件的位置，备份文件是从 A 机器拷贝过来的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1">###################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 这步是 RESTORE DATEBASE</span>
</span></span><span class="line"><span class="cl"><span class="c1">###################</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux2 bin<span class="o">]</span>$ ./dmrman <span class="nv">CTLSTMT</span><span class="o">=</span><span class="s2">&#34;RESTORE DATABASE &#39;/home/dmdba/dmdbms/DMDB/dm.ini&#39; FROM BACKUPSET &#39;/home/dmdba/dmdbms/DMDB/bak/BACKUP_FILE&#39;&#34;</span>
</span></span><span class="line"><span class="cl">dmrman V8
</span></span><span class="line"><span class="cl">RESTORE DATABASE <span class="s1">&#39;/home/dmdba/dmdbms/DMDB/dm.ini&#39;</span> FROM BACKUPSET <span class="s1">&#39;/home/dmdba/dmdbms/DMDB/bak/BACKUP_FILE&#39;</span>
</span></span><span class="line"><span class="cl">file dm.key not found, use default license!
</span></span><span class="line"><span class="cl">Normal of FAST
</span></span><span class="line"><span class="cl">Normal of DEFAULT
</span></span><span class="line"><span class="cl">Normal of RECYCLE
</span></span><span class="line"><span class="cl">Normal of KEEP
</span></span><span class="line"><span class="cl">Normal of ROLL
</span></span><span class="line"><span class="cl"><span class="o">[</span>Percent:100.00%<span class="o">][</span>Speed:0.00M/s<span class="o">][</span>Cost:00:00:03<span class="o">][</span>Remaining:00:00:00<span class="o">]</span>
</span></span><span class="line"><span class="cl">restore successfully.
</span></span><span class="line"><span class="cl"><span class="nb">time</span> used: 00:00:03.874
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">###################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 这步是 RECOVER DATEBASE</span>
</span></span><span class="line"><span class="cl"><span class="c1">###################</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux2 bin<span class="o">]</span>$ ./dmrman <span class="nv">CTLSTMT</span><span class="o">=</span><span class="s2">&#34;RECOVER DATABASE &#39;/home/dmdba/dmdbms/DMDB/dm.ini&#39; FROM BACKUPSET &#39;/home/dmdba/dmdbms/DMDB/bak/BACKUP_FILE&#39;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">###################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 这步是 RECOVER DATEBASE UPDATE DM_MAGIC</span>
</span></span><span class="line"><span class="cl"><span class="c1">###################</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux2 bin<span class="o">]</span>$ ./dmrman <span class="nv">CTLSTMT</span><span class="o">=</span><span class="s2">&#34;RECOVER DATABASE &#39;/home/dmdba/dmdbms/DMDB/dm.ini&#39; UPDATE DB_MAGIC&#34;</span>
</span></span><span class="line"><span class="cl">dmrman V8
</span></span><span class="line"><span class="cl">RECOVER DATABASE <span class="s1">&#39;/home/dmdba/dmdbms/DMDB/dm.ini&#39;</span> UPDATE DB_MAGIC
</span></span><span class="line"><span class="cl">file dm.key not found, use default license!
</span></span><span class="line"><span class="cl">Database <span class="nv">mode</span> <span class="o">=</span> 2, <span class="nv">oguid</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">Normal of FAST
</span></span><span class="line"><span class="cl">Normal of DEFAULT
</span></span><span class="line"><span class="cl">Normal of RECYCLE
</span></span><span class="line"><span class="cl">Normal of KEEP
</span></span><span class="line"><span class="cl">Normal of ROLL
</span></span><span class="line"><span class="cl">EP<span class="o">[</span>0<span class="o">]</span><span class="err">&#39;</span>s cur_lsn<span class="o">[</span>42972<span class="o">]</span>, file_lsn<span class="o">[</span>42972<span class="o">]</span>
</span></span><span class="line"><span class="cl">recover successfully!
</span></span><span class="line"><span class="cl"><span class="nb">time</span> used: 00:00:01.421
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2创建-dmarchini">2）创建 dmarch.ini
</h4><p>A 机器开启了归档，B 机器是还没有开启归档的，所以没有归档配置文件 <code>dmarch.ini</code> 的，在 B 机器创建它</p>
<p>注意 <code>ARCH_DEST</code> 参数，主库的 dmarch.ini 文件填备库的实例名，备库的 dmarch.ini 文件填主库的实例名</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nv">ARCH_WAIT_APPLY</span>            <span class="o">=</span> <span class="m">0</span>   <span class="c1">#0：高性能 1：事务一致</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>ARCHIVE_LOCAL<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">ARCH_TYPE</span>                <span class="o">=</span> LOCAL  <span class="c1">#本地归档类型</span>
</span></span><span class="line"><span class="cl"><span class="nv">ARCH_DEST</span>                <span class="o">=</span> /home/dmdba/dmdbms/DMDB/arch/  <span class="c1">#本地归档存放路径</span>
</span></span><span class="line"><span class="cl"><span class="nv">ARCH_FILE_SIZE</span>           <span class="o">=</span> <span class="m">1024</span>  <span class="c1">#单个归档大小，单位 MB</span>
</span></span><span class="line"><span class="cl"><span class="nv">ARCH_SPACE_LIMIT</span>         <span class="o">=</span> <span class="m">10240</span>  <span class="c1">#归档上限，单位 MB</span>
</span></span><span class="line"><span class="cl"><span class="nv">ARCH_FLUSH_BUF_SIZE</span>      <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="nv">ARCH_HANG_FLAG</span>           <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>ARCHIVE_REALTIME1<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">ARCH_TYPE</span>                <span class="o">=</span> REALTIME  <span class="c1">#实时归档类型</span>
</span></span><span class="line"><span class="cl"><span class="nv">ARCH_DEST</span>                <span class="o">=</span> GRP_TEST_01  <span class="c1">#实时归档目标实例名，这里则填主库的实例</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3修改-dmini">3）修改 dm.ini
</h4><p>在 B 机器上修改 <code>dm.ini</code> ，它比 A 机器上多了一个参数修改 <code>ARCH_INI = 1</code> 打开归档配置</p>
<p>因为 A 机器是通过 SQL 的方式打开归档的，B 机器这里并没有启动服务，所以通过修改参数文件的方式开启</p>
<p>并且确保文件里的实例名为：<code>GRP_TEST_02</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux2 DMDB<span class="o">]</span>$ vi /home/dmdba/dmdbms/DMDB/dm.ini
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">INSTANCE_NAME</span>  <span class="o">=</span> GRP_TEST_02
</span></span><span class="line"><span class="cl"><span class="nv">PORT_NUM</span> <span class="o">=</span> <span class="m">5236</span>                        <span class="c1">#数据库实例监听端口</span>
</span></span><span class="line"><span class="cl"><span class="nv">DW_INACTIVE_INTERVAL</span> <span class="o">=</span> <span class="m">60</span>              <span class="c1">#接收守护进程消息超时时间</span>
</span></span><span class="line"><span class="cl"><span class="nv">ALTER_MODE_STATUS</span> <span class="o">=</span> <span class="m">0</span>                  <span class="c1">#不允许手工方式修改实例模式/状态/OGUID</span>
</span></span><span class="line"><span class="cl"><span class="nv">ENABLE_OFFLINE_TS</span>  <span class="o">=</span> <span class="m">2</span>                 <span class="c1">#不允许备库 OFFLINE 表空间</span>
</span></span><span class="line"><span class="cl"><span class="nv">MAL_INI</span> <span class="o">=</span> <span class="m">1</span>                            <span class="c1">#打开 MAL 系统</span>
</span></span><span class="line"><span class="cl"><span class="nv">ARCH_INI</span> <span class="o">=</span> <span class="m">1</span>                           <span class="c1">#打开归档配置</span>
</span></span><span class="line"><span class="cl"><span class="nv">RLOG_SEND_APPLY_MON</span> <span class="o">=</span> <span class="m">64</span>               <span class="c1">#统计最近 64 次的日志重演信息</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="4创建-dmmalini">4）创建 dmmal.ini
</h4><p>配置它与 A 机器的参数相同（即保持与主库一致），用 A 机器的 <code>dmmal.ini</code> 配置即可</p>
<h4 id="5创建-dmwatcherini">5）创建 dmwatcher.ini
</h4><p>配置它与 A 机器的参数相同（即保持与主库一致），用 A 机器的 <code>dmwatcher.ini</code> 配置即可</p>
<h4 id="6注册服务">6）注册服务
</h4><p>使用 <code>root</code> 用户执行，跟 A 机器的注册服务类似，创建一个 GRP_TEST_02 实例服务，创建一个数据守护服务</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@linux2 root<span class="o">]</span><span class="c1"># ./dm_service_installer.sh -t dmserver -p GRP_TEST_02 -dm_ini /home/dmdba/dmdbms/DMDB/dm.ini -m mount</span>
</span></span><span class="line"><span class="cl">Created symlink from /etc/systemd/system/multi-user.target.wants/DmServiceGRP_TEST_02.service to /usr/lib/systemd/system/DmServiceGRP_TEST_02.service.
</span></span><span class="line"><span class="cl">创建服务<span class="o">(</span>DmServiceGRP_TEST_02<span class="o">)</span>完成
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@linux2 root<span class="o">]</span><span class="c1"># ./dm_service_installer.sh -t dmwatcher -p Watcher -watcher_ini /home/dmdba/dmdbms/DMDB/dmwatcher.ini</span>
</span></span><span class="line"><span class="cl">Created symlink from /etc/systemd/system/multi-user.target.wants/DmWatcherServiceWatcher.service to /usr/lib/systemd/system/DmWatcherServiceWatcher.service.
</span></span><span class="line"><span class="cl">创建服务<span class="o">(</span>DmWatcherServiceWatcher<span class="o">)</span>完成
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="注意">【注意】
</h6><p>一般生产上通常的配置，是两台，一主一备，并没有给配置监视器的机器，所以。到这里，其实我们的实时主备就搭建完成了，剩下的就是做启动集群服务，和验证是否真的实时同步数据。</p>
<h3 id="监视器">监视器
</h3><h4 id="需要监视器的说明">需要监视器的说明
</h4><p>如果需要监视器，则应该再使用一台服务器，单独部署监视器，用来监控集群服务，以及实现自动切换主备。现有接触到的项目，监视器直接部署到了主库服务器上了。</p>
<p>需要监视器，则按照此步骤继续部署监视器，否则请跳过该步骤，往下接【3.5 启动服务】步骤</p>
<p>为了更贴近实际项目，所以我在 A 机器（192.168.163.9）上安装（反正随便装在一台上）监视器</p>
<h4 id="1创建-dmmonitorini">1）创建 dmmonitor.ini
</h4><p>这个是确认监视器，就是<code>MON_DW_CONFIRE=1</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux1 DMDB<span class="o">]</span><span class="c1"># vi dmmonitor.ini</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">MON_DW_CONFIRM</span>             <span class="o">=</span> <span class="m">1</span>  <span class="c1">#0：非确认（故障手切） 1：确认（故障自切）</span>
</span></span><span class="line"><span class="cl"><span class="nv">MON_LOG_PATH</span>               <span class="o">=</span> ../log_monitor  <span class="c1">#监视器日志文件存放路径</span>
</span></span><span class="line"><span class="cl"><span class="nv">MON_LOG_INTERVAL</span>           <span class="o">=</span> <span class="m">60</span>  <span class="c1">#每隔 60s 定时记录系统信息到日志文件</span>
</span></span><span class="line"><span class="cl"><span class="nv">MON_LOG_FILE_SIZE</span>          <span class="o">=</span> <span class="m">32</span>  <span class="c1">#单个日志大小，单位 MB</span>
</span></span><span class="line"><span class="cl"><span class="nv">MON_LOG_SPACE_LIMIT</span>        <span class="o">=</span> <span class="m">1024</span>  <span class="c1">#日志上限，单位 MB</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>GRP1<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">MON_INST_OGUID</span>           <span class="o">=</span> <span class="m">45331</span>  <span class="c1">#组 GRP1 的唯一 OGUID 值</span>
</span></span><span class="line"><span class="cl"><span class="nv">MON_DW_IP</span>                <span class="o">=</span> 192.168.163.9:5436  <span class="c1">#IP 对应 MAL_HOST，PORT 对应 MAL_DW_PORT</span>
</span></span><span class="line"><span class="cl"><span class="nv">MON_DW_IP</span>                <span class="o">=</span> 192.168.163.10:5436
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2创建-dmmonitor_manualini">2）创建 dmmonitor_manual.ini
</h4><p>再配置一个非监视器，就是 <code>MON_DW_CONFIRE=0</code></p>
<p>它可以在手动切换的时候，直接通过这个非监视器命令去手动切换，就不需要这么麻烦的切换主备数据库模式了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux1 DMDB<span class="o">]</span><span class="c1"># vi dmmonitor_manaul.ini</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">MON_DW_CONFIRM</span>             <span class="o">=</span> <span class="m">0</span>  <span class="c1">#0：非确认（故障手切） 1：确认（故障自切）</span>
</span></span><span class="line"><span class="cl"><span class="nv">MON_LOG_PATH</span>               <span class="o">=</span> ../log_monitor  <span class="c1">#监视器日志文件存放路径</span>
</span></span><span class="line"><span class="cl"><span class="nv">MON_LOG_INTERVAL</span>           <span class="o">=</span> <span class="m">60</span>  <span class="c1">#每隔 60s 定时记录系统信息到日志文件</span>
</span></span><span class="line"><span class="cl"><span class="nv">MON_LOG_FILE_SIZE</span>          <span class="o">=</span> <span class="m">32</span>  <span class="c1">#单个日志大小，单位 MB</span>
</span></span><span class="line"><span class="cl"><span class="nv">MON_LOG_SPACE_LIMIT</span>        <span class="o">=</span> <span class="m">1024</span>  <span class="c1">#日志上限，单位 MB</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>GRP1<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">MON_INST_OGUID</span>           <span class="o">=</span> <span class="m">45331</span>  <span class="c1">#组 GRP1 的唯一 OGUID 值</span>
</span></span><span class="line"><span class="cl"><span class="nv">MON_DW_IP</span>                <span class="o">=</span> 192.168.163.9:5436  <span class="c1">#IP 对应 MAL_HOST，PORT 对应 MAL_DW_PORT</span>
</span></span><span class="line"><span class="cl"><span class="nv">MON_DW_IP</span>                <span class="o">=</span> 192.168.163.10:5436
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3注册监视器服务">3）注册监视器服务
</h4><p>【注意】确认监视器需要注册服务，非确认监视器不需要注册服务</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@linux1 root<span class="o">]</span><span class="c1"># ./dm_service_installer.sh -t dmmonitor -p Monitor -monitor_ini /home/dmdba/dmdbms/DMDB/dmmonitor.ini</span>
</span></span><span class="line"><span class="cl">Created symlink from /etc/systemd/system/multi-user.target.wants/DmMonitorServiceMonitor.service to /usr/lib/systemd/system/DmMonitorServiceMonitor.service.
</span></span><span class="line"><span class="cl">创建服务<span class="o">(</span>DmMonitorServiceMonitor<span class="o">)</span>完成
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="附删除监视器服务">附：删除监视器服务
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@linux1 root<span class="o">]</span><span class="c1"># ./dm_service_uninstaller.sh -n DmMonitorServiceMonitor</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="4监视器启动">4）监视器启动
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux1 bin<span class="o">]</span><span class="c1"># ./DmMonitorServiceMonitor start</span>
</span></span><span class="line"><span class="cl">Starting DmMonitorServiceMonitor: 上一次登录：日 7月 <span class="m">21</span> 11:07:16 CST 2024pts/1 上	<span class="o">[</span>OK<span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>监视器的启动，需要在达梦数据库服务启动才能启</p>
<h4 id="5非确认监视器的使用">5）非确认监视器的使用
</h4><p>确认监视器为自动切换，所以不需要使用它</p>
<p>只有需要手动切换主备的时候，使用非确认监视器就行</p>
<h5 id="51进入非确认监视器">5.1）进入非确认监视器
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux1 bin<span class="o">]</span>$ ./dmmonitor ../DMDB/dmmonitor_manual.ini
</span></span><span class="line"><span class="cl"><span class="o">[</span>monitor<span class="o">]</span>         2024-07-22 21:44:14: DMMONITOR<span class="o">[</span>4.0<span class="o">]</span> V8
</span></span><span class="line"><span class="cl"><span class="o">[</span>monitor<span class="o">]</span>         2024-07-22 21:44:15: DMMONITOR<span class="o">[</span>4.0<span class="o">]</span> IS READY.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>monitor<span class="o">]</span>         2024-07-22 21:44:15:
</span></span><span class="line"><span class="cl"><span class="c1">#-----------------------------------------------------------------------------------------------#</span>
</span></span><span class="line"><span class="cl">GET MONITOR CONNECT INFO FROM DMWATCHER<span class="o">(</span>GRP_TEST_01<span class="o">)</span>, THE FIRST LINE IS SELF INFO.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">DW_CONN_TIME         MON_CONFIRM    MID            MON_IP                MON_VERSION
</span></span><span class="line"><span class="cl">2024-07-22 21:44:15  FALSE          <span class="m">930807350</span>      ::ffff:192.168.163.9  DMMONITOR<span class="o">[</span>4.0<span class="o">]</span> V8
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2024-07-22 21:34:50  TRUE           <span class="m">826253418</span>      ::ffff:192.168.163.9  DMMONITOR<span class="o">[</span>4.0<span class="o">]</span> V8
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#-----------------------------------------------------------------------------------------------#</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>monitor<span class="o">]</span>         2024-07-22 21:44:15: 收到守护进程<span class="o">(</span>GRP_TEST_01<span class="o">)</span>消息
</span></span><span class="line"><span class="cl">                  WTIME                WSTATUS        INST_OK   INAME            ISTATUS     IMODE     RSTAT    N_OPEN   FLSN            CLSN
</span></span><span class="line"><span class="cl">                  2024-07-22 21:44:15  OPEN           OK        GRP_TEST_01      OPEN        STANDBY   NULL     <span class="m">5</span>        <span class="m">43526</span>           <span class="m">43526</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>monitor<span class="o">]</span>         2024-07-22 21:44:15: 收到守护进程<span class="o">(</span>GRP_TEST_02<span class="o">)</span>消息
</span></span><span class="line"><span class="cl">                  WTIME                WSTATUS        INST_OK   INAME            ISTATUS     IMODE     RSTAT    N_OPEN   FLSN            CLSN
</span></span><span class="line"><span class="cl">                  2024-07-22 21:44:15  OPEN           OK        GRP_TEST_02      OPEN        PRIMARY   VALID    <span class="m">5</span>        <span class="m">43526</span>           <span class="m">43526</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="52监视器命令">5.2）监视器命令
</h5><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th style="text-align: left">命令</th>
          <th style="text-align: left">含义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">list</td>
          <td style="text-align: left">查看守护进程的配置信息</td>
      </tr>
      <tr>
          <td style="text-align: left">show global info</td>
          <td style="text-align: left">查看所有实例组的信息</td>
      </tr>
      <tr>
          <td style="text-align: left">tip</td>
          <td style="text-align: left">查看系统当前允许状态</td>
      </tr>
      <tr>
          <td style="text-align: left">login</td>
          <td style="text-align: left">登录监视器，使用的具有 DBA 权限数据库用户，非服务器用户</td>
      </tr>
      <tr>
          <td style="text-align: left">logout</td>
          <td style="text-align: left">退出登录</td>
      </tr>
      <tr>
          <td style="text-align: left">choose switchover GRP1</td>
          <td style="text-align: left">主机正常时，查看可切换为主机的实例</td>
      </tr>
      <tr>
          <td style="text-align: left">switchover GRP1.GRP_TEST_01</td>
          <td style="text-align: left">主机正常时，使用指定组.实例 切换为主机</td>
      </tr>
      <tr>
          <td style="text-align: left">choose takeover GRP1</td>
          <td style="text-align: left">主机故障时，查看可切换为主机的实例</td>
      </tr>
      <tr>
          <td style="text-align: left">takeover GRP1.GRP_TEST_01</td>
          <td style="text-align: left">主机故障时，使用指定组.实例 切换为主机</td>
      </tr>
      <tr>
          <td style="text-align: left">choose takeover force GRP1</td>
          <td style="text-align: left">查看可强制切换为主机的实例</td>
      </tr>
      <tr>
          <td style="text-align: left">takeover force GRP1.GRP_TEST_01</td>
          <td style="text-align: left">使用组.实例 强制切换为主机</td>
      </tr>
  </tbody>
</table></div>
<p>使用命令例子：都是进入监视器后直接输入即可</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain"><span class="line"><span class="cl">login
</span></span><span class="line"><span class="cl">用户名:SYSDBA
</span></span><span class="line"><span class="cl">密码:
</span></span><span class="line"><span class="cl">[monitor]         2024-07-22 21:46:33: 登录监视器成功!
</span></span><span class="line"><span class="cl">tip
</span></span><span class="line"><span class="cl">[monitor]         2024-07-22 21:49:01: [!!! 提示：本监视器不是确认监视器，在故障自动切换模式下如果发生主库故障，本监视器无法执行自动接管 !!!]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[monitor]         2024-07-22 21:49:01: 实例GRP_TEST_02[PRIMARY, OPEN, ISTAT_SAME:TRUE]不可加入其他实例，守护进程状态：OPEN，Open记录状态：VALID
</span></span><span class="line"><span class="cl">[monitor]         2024-07-22 21:49:01: 实例GRP_TEST_02[PRIMARY, OPEN, ISTAT_SAME:TRUE]当前没有命令正在执行
</span></span><span class="line"><span class="cl">[monitor]         2024-07-22 21:49:01: 实例GRP_TEST_02[PRIMARY, OPEN, ISTAT_SAME:TRUE]运行正常, 守护进程是OPEN状态，守护类型是GLOBAL
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[monitor]         2024-07-22 21:49:01: 实例GRP_TEST_01[STANDBY, OPEN, ISTAT_SAME:TRUE]可加入实例GRP_TEST_02[PRIMARY, OPEN, ISTAT_SAME:TRUE]
</span></span><span class="line"><span class="cl">[monitor]         2024-07-22 21:49:01: 实例GRP_TEST_01[STANDBY, OPEN, ISTAT_SAME:TRUE]当前没有命令正在执行
</span></span><span class="line"><span class="cl">[monitor]         2024-07-22 21:49:01: 实例GRP_TEST_01[STANDBY, OPEN, ISTAT_SAME:TRUE]运行正常, 守护进程是OPEN状态，守护类型是GLOBAL
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[monitor]         2024-07-22 21:49:01: 组(GRP1)当前活动实例运行正常
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[monitor]         2024-07-22 21:49:01: 所有组中的活动实例运行正常！
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="启动服务">启动服务
</h3><h4 id="启动数据库并修改参数">启动数据库并修改参数
</h4><p>A 机器，启动数据库实例服务，并修改 <code>OGUID</code> 为 <code>dmwatcher.ini</code> 里配置的 <code>OGUID</code> 一致，并将 A 机器的库设置为 <code>PRIMARY</code> 模式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux1 bin<span class="o">]</span>$ ./DmServiceGRP_TEST_01 start
</span></span><span class="line"><span class="cl">Starting DmServiceGRP_TEST_01:                             <span class="o">[</span> OK <span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux1 bin<span class="o">]</span>$ ./disql SYSDBA/SYSDBA
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">服务器<span class="o">[</span>LOCALHOST:5236<span class="o">]</span>:处于普通配置状态
</span></span><span class="line"><span class="cl">登录使用时间 : 19.397<span class="o">(</span>ms<span class="o">)</span>
</span></span><span class="line"><span class="cl">disql V8
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SQL&gt; SP_SET_PARA_VALUE<span class="o">(</span>1,<span class="s1">&#39;ALTER_MODE_STATUS&#39;</span>,1<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">DMSQL 过程已成功完成
</span></span><span class="line"><span class="cl">已用时间: 40.185<span class="o">(</span>毫秒<span class="o">)</span>. 执行号:1.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 修改 OGUID</span>
</span></span><span class="line"><span class="cl"><span class="c1">################</span>
</span></span><span class="line"><span class="cl">SQL&gt; SP_SET_OGUID<span class="o">(</span>45331<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">DMSQL 过程已成功完成
</span></span><span class="line"><span class="cl">已用时间: 10.529<span class="o">(</span>毫秒<span class="o">)</span>. 执行号:2.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#########################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 修改为主库为 PRIMARY 模式</span>
</span></span><span class="line"><span class="cl"><span class="c1">#########################</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SQL&gt; ALTER DATABASE PRIMARY<span class="p">;</span>
</span></span><span class="line"><span class="cl">操作已执行
</span></span><span class="line"><span class="cl">已用时间: 34.763<span class="o">(</span>毫秒<span class="o">)</span>. 执行号:0.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SQL&gt; SP_SET_PARA_VALUE<span class="o">(</span>1,<span class="s1">&#39;ALTER_MODE_STATUS&#39;</span>,0<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">DMSQL 过程已成功完成
</span></span><span class="line"><span class="cl">已用时间: 26.340<span class="o">(</span>毫秒<span class="o">)</span>. 执行号:3.
</span></span></code></pre></td></tr></table>
</div>
</div><p>B 机器，启动数据库实例服务，并修改 <code>OGUID</code> 为 <code>dmwatcher.ini</code> 里配置的 <code>OGUID</code> 一致，并将 B 机器的库设置为 <code>STANDBY</code> 模式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux2 bin<span class="o">]</span>$ ./DmServiceGRP_TEST_02 start
</span></span><span class="line"><span class="cl">Starting DmServiceGRP_TEST_02:                             <span class="o">[</span> OK <span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux2 bin<span class="o">]</span>$ ./disql SYSDBA/SYSDBA
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">服务器<span class="o">[</span>LOCALHOST:5236<span class="o">]</span>:处于普通配置状态
</span></span><span class="line"><span class="cl">登录使用时间 : 48.562<span class="o">(</span>ms<span class="o">)</span>
</span></span><span class="line"><span class="cl">disql V8
</span></span><span class="line"><span class="cl">SQL&gt; SP_SET_PARA_VALUE<span class="o">(</span>1,<span class="s1">&#39;ALTER_MODE_STATUS&#39;</span>,1<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">DMSQL 过程已成功完成
</span></span><span class="line"><span class="cl">已用时间: 50.707<span class="o">(</span>毫秒<span class="o">)</span>. 执行号:1.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SQL&gt; SP_SET_OGUID<span class="o">(</span>45331<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">DMSQL 过程已成功完成
</span></span><span class="line"><span class="cl">已用时间: 8.188<span class="o">(</span>毫秒<span class="o">)</span>. 执行号:2.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SQL&gt; ALTER DATABASE STANDBY<span class="p">;</span>
</span></span><span class="line"><span class="cl">操作已执行
</span></span><span class="line"><span class="cl">已用时间: 48.859<span class="o">(</span>毫秒<span class="o">)</span>. 执行号:0.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SQL&gt; SP_SET_PARA_VALUE<span class="o">(</span>1,<span class="s1">&#39;ALTER_MODE_STATUS&#39;</span>,0<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">DMSQL 过程已成功完成
</span></span><span class="line"><span class="cl">已用时间: 36.601<span class="o">(</span>毫秒<span class="o">)</span>. 执行号:3.
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="启动守护进程">启动守护进程
</h4><p>机器 A 和 B 都启动数据守护进程</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux1 bin<span class="o">]</span>$ ./DmWatcherServiceWatcher start
</span></span><span class="line"><span class="cl">Starting DmWatcherServiceWatcher:                          <span class="o">[</span> OK <span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>到这里，数据库服务启动完毕！</strong></p>
<h3 id="附集群启停">附：集群启停
</h3><p>在刚部署时，按照 数据库 &raquo; 数据守护 的顺序，如上</p>
<p>如果需要重启时，则应该：数据守护停止 &raquo; 数据库重启 &raquo; 数据守护启动</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nb">cd</span> /home/dmdba/dmdbms/bin
</span></span><span class="line"><span class="cl">./DmWatcherServiceWatcher stop
</span></span><span class="line"><span class="cl">./DmServiceGRP_TEST_01 restart
</span></span><span class="line"><span class="cl">./DmWatcherServiceWatcher start
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果需要停止时，则应该：数据守护停止 &raquo; 数据库停止</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nb">cd</span> /home/dmdba/dmdbms/bin
</span></span><span class="line"><span class="cl">./DmWatcherServiceWatcher stop
</span></span><span class="line"><span class="cl">./DmServiceGRP_TEST_01 stop
</span></span></code></pre></td></tr></table>
</div>
</div><p>有监视器的情况下：</p>
<p>启动：数据库实例 &raquo; 数据守护 &raquo; 监视器</p>
<p>停止：监视器 &raquo; 数据守护 &raquo; 数据库实例</p>
<p>重启同上</p>
<h2 id="配置-dm_svcconf">配置 dm_svc.conf
</h2><p>达梦数据库在安装完成后，在 <code>/etc</code> 目录下生成一个 <code>dm_svc.conf</code> 文件，用于实现达梦集群的故障自动重连、读写分离</p>
<p>并且它可以在 JDBC 中使用，连接数据库时指定连接服务名，接口会随机选择 一个 IP 进行连接，如果连接不成功或者服务器状态不正确，则顺序获取下一个 IP 进行连接， 直至连接成功或者遍历了所有 IP 。</p>
<p>在 <a class="link" href="https://weiqifun.github.io/2024/06/06/%e5%ae%9e%e6%96%bd%e9%83%a8%e7%bd%b2-%e8%be%be%e6%a2%a6%e6%95%b0%e6%8d%ae%e5%ba%93%e7%9a%84%e5%ae%89%e8%a3%85/#%e8%be%be%e6%a2%a6%e9%9b%86%e7%be%a4%e5%ae%88%e6%8a%a4"  target="_blank" rel="noopener"
    >实施部署-达梦数据库linux版的安装（二） | WeiQi Blog (weiqifun.github.io)</a> 也记录总结过</p>
<p>官方文档《DM8系统管理员手册.pdf》2.1.1.4 章节介绍了这个文件里详细的参数</p>
<h3 id="实时主备服务名配置">实时主备服务名配置
</h3><p>这个是需要数据库服务器上配置，应用服务器上也要配置，即应用如果想要通过服务名连接数据库，则也需要配置这个文件，双方才能互相通信</p>
<p>linux 在 <code>/etc/dm_svc.conf</code></p>
<p>windows 在 <code>C:\Windows\System32</code> （多数 64 位机器是这个位置，反正是在 <code>%SystemRoot%\system32</code> 下）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">vi /etc/dm_svc.conf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">###################### 添加以下内容 #############################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 全局配置</span>
</span></span><span class="line"><span class="cl"><span class="nv">TIME_ZONE</span><span class="o">=(</span>480<span class="o">)</span> <span class="c1"># 时区 +8:00   60一个时区</span>
</span></span><span class="line"><span class="cl"><span class="nv">LANGUAGE</span><span class="o">=(</span>cn<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">GRP1</span><span class="o">=(</span>192.168.163.9:5236,192.168.163.10:5236<span class="o">)</span>   <span class="c1"># 服务名 = (各个数据库的 IP:PORT ) 逗号分割</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 服务配置</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>GRP1<span class="o">]</span>
</span></span><span class="line"><span class="cl">TIME+ZONE<span class="o">=(</span>+480<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 指定优先登录的服务器模式 0-优先PRIMARY 1-只连接主库 2-只连接备库 3-优先STANDBY 4-优先NORMAL（缺省默认）</span>
</span></span><span class="line"><span class="cl"><span class="nv">LOGIN_MODE</span><span class="o">=(</span>1<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">SWITCH_TIME</span><span class="o">=(</span>3<span class="o">)</span> <span class="c1"># 以服务名连接数据库时，发生故障时，失败重连次数</span>
</span></span><span class="line"><span class="cl"><span class="nv">SWITCH_INTERVAL</span><span class="o">=(</span>200<span class="o">)</span>   <span class="c1"># 主备服务器切换、重连等待的时间间隔，毫秒</span>
</span></span><span class="line"><span class="cl"><span class="c1">###################### 以上为实时主备数据守护配置 #####################################</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 读写分离配置</span>
</span></span><span class="line"><span class="cl"><span class="nv">RW_SEPARATE</span><span class="o">=(</span>1<span class="o">)</span> <span class="c1"># 启用读写分离，使用此参数时，LOGIN_MODE 参数失效</span>
</span></span><span class="line"><span class="cl"><span class="nv">RW_PERCENT</span><span class="o">=(</span>25<span class="o">)</span> <span class="c1"># 读写分离时，读写分离的分发比例</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="jdbc-连接">JDBC 连接
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">jdbc:dm://GRP1?schema<span class="o">=</span>TEST
</span></span><span class="line"><span class="cl">jdbc:dm://GRP1?schema<span class="o">=</span>TEST<span class="p">&amp;</span><span class="nv">columnNameUpperCase</span><span class="o">=</span><span class="nb">false</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="达梦管理工具连接">达梦管理工具连接
</h3><p>因为目前手上的机器为 LINUX + WINDOWS ，应用在 WINDOWS 上，所以我在 <code>C:\Windows\System32</code> 找到该文件，然后进行相同的配置。应用在 LINUX 上则同理数据库服务器上的路径。</p>
<p><img src="/posts/2024/07/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5%E4%BA%8C/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5/1721612050048-ce832c80-2a45-497b-aa75-c8eb1a9fb1fc-1724069074876-3.png"
	width="974"
	height="227"
	srcset="/posts/2024/07/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5%E4%BA%8C/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5/1721612050048-ce832c80-2a45-497b-aa75-c8eb1a9fb1fc-1724069074876-3_hu11597249365258225851.png 480w, /posts/2024/07/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5%E4%BA%8C/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5/1721612050048-ce832c80-2a45-497b-aa75-c8eb1a9fb1fc-1724069074876-3_hu3986530222856572534.png 1024w"
	loading="lazy"
	
		alt="img"
	
	
		class="gallery-image" 
		data-flex-grow="429"
		data-flex-basis="1029px"
	
></p>
<p>把客户端重启，配置才会生效</p>
<p><img src="/posts/2024/07/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5%E4%BA%8C/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5/1721570438572-4739de2f-ab29-44b7-8977-9f86cd4f154d-1724069074876-5.png"
	width="679"
	height="609"
	srcset="/posts/2024/07/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5%E4%BA%8C/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5/1721570438572-4739de2f-ab29-44b7-8977-9f86cd4f154d-1724069074876-5_hu12928234169331603491.png 480w, /posts/2024/07/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5%E4%BA%8C/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5/1721570438572-4739de2f-ab29-44b7-8977-9f86cd4f154d-1724069074876-5_hu7822166006926399345.png 1024w"
	loading="lazy"
	
		alt="img"
	
	
		class="gallery-image" 
		data-flex-grow="111"
		data-flex-basis="267px"
	
></p>
<p>到这里也就 OK 了，服务名配置成功</p>
<h3 id="验证-主库挂掉后是否会自动切换">验证-主库挂掉后是否会自动切换
</h3><h4 id="1停止主库">1）停止主库
</h4><p>采用的方式为停止主库（即把主库的DmWatcher守护进程服务、DmService服务停止掉），看看使用服务名是否能连接到备库</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux1 bin<span class="o">]</span>$ ./DmWatcherServiceWatcher stop
</span></span><span class="line"><span class="cl">Stopping DmWatcherServiceWatcher:                          <span class="o">[</span> OK <span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux1 bin<span class="o">]</span>$ ./DmServiceGRP_TEST_01 stop
</span></span><span class="line"><span class="cl">Stopping DmServiceGRP_TEST_01:                             <span class="o">[</span> OK <span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>我把达梦客户端重启，重新连接 <code>GRP1</code></p>
<p><img src="/posts/2024/07/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5%E4%BA%8C/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5/1721570476789-1163da73-4969-46a3-8891-7dd2bb9dae2a-1724069074876-7.png"
	width="546"
	height="480"
	srcset="/posts/2024/07/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5%E4%BA%8C/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5/1721570476789-1163da73-4969-46a3-8891-7dd2bb9dae2a-1724069074876-7_hu14199568267717227932.png 480w, /posts/2024/07/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5%E4%BA%8C/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5/1721570476789-1163da73-4969-46a3-8891-7dd2bb9dae2a-1724069074876-7_hu1071907193589848984.png 1024w"
	loading="lazy"
	
		alt="img"
	
	
		class="gallery-image" 
		data-flex-grow="113"
		data-flex-basis="273px"
	
></p>
<p>报错服务器模式不匹配，因为 dm_svc.conf 的 LOGIN_MODE = 1 只连接 PRIMARY 库，因此主库挂掉后无法连接到备库</p>
<p>修改数据库服务器、应用服务器的 <code>dm_svc.conf</code> 配置文件，修改里边的 <code>LOGIN_MODE=0</code> ，优先连接 <code>PRIMARY</code></p>
<p>再重启客户端，重连 <code>GRP1</code></p>
<p>嗯，这个连接过程会有明显的卡顿了一下，估计是在遍历 GRP1 里的数据库实例</p>
<p>当前连的是备库（备库是 STANDBY 模式，因为没有监视器，所以是不会自动切换主备的，我这边没有手动切换，所以连接到备库，只提供只读服务）</p>
<h4 id="2重启主库">2）重启主库
</h4><p>把主库重新启动，再重启客户端连接，连接正常的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">NAME</span><span class="p">,</span><span class="w"> </span><span class="n">INSTANCE_NAME</span><span class="p">,</span><span class="w"> </span><span class="n">STATUS$</span><span class="p">,</span><span class="w"> </span><span class="k">MODE</span><span class="err">$</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">V$INSTANCE</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- MODE$ 的值为 PRIMARY
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="验证实时同步">验证实时同步
</h2><h3 id="验证一主库操作">验证一：主库操作
</h3><h4 id="1执行创建表空间用户授权等操作">1）执行创建表空间、用户、授权等操作
</h4><p>打开达梦管理工具，连接到主库（192.168.163.9:5236），默认的管理员用户 <code>SYSDBA/SYSDBA</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="n">TABLESPACE</span><span class="w"> </span><span class="s2">&#34;TS_TEST&#34;</span><span class="w"> </span><span class="n">DATAFILE</span><span class="w"> </span><span class="s1">&#39;/home/dmdba/dmdbms/DMDB/TS_TEST.DBF&#39;</span><span class="w"> </span><span class="k">SIZE</span><span class="w"> </span><span class="mi">500</span><span class="w"> </span><span class="n">AUTOEXTEND</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">NEXT</span><span class="w"> </span><span class="mi">40</span><span class="w"> </span><span class="n">MAXSIZE</span><span class="w"> </span><span class="mi">2048</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">USER</span><span class="w"> </span><span class="s2">&#34;TEST&#34;</span><span class="w"> </span><span class="n">IDENTIFIED</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="s2">&#34;TEST123456&#34;</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">TABLESPACE</span><span class="w"> </span><span class="s2">&#34;TS_TEST&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GRANT</span><span class="w"> </span><span class="s2">&#34;DBA&#34;</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="s2">&#34;TEST&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GRANT</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">ANY</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">TEST</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GRANT</span><span class="w"> </span><span class="k">EXECUTE</span><span class="w"> </span><span class="k">ANY</span><span class="w"> </span><span class="k">PROCEDURE</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">TEST</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GRANT</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">ANY</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">TEST</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">ANY</span><span class="w"> </span><span class="k">DICTIONARY</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">TEST</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">ANY</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">TEST</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GRANT</span><span class="w"> </span><span class="n">UNLIMITED</span><span class="w"> </span><span class="n">TABLESPACE</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">TEST</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GRANT</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">ANY</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">TEST</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>连接备库（192.168.163.10:5236），验证是否有刚刚创建的表空间、用户</p>
<p><img src="/posts/2024/07/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5%E4%BA%8C/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5/1721612144703-32325106-f9d5-46de-b8f4-cc11de3b0164-1724069074876-9.png"
	width="512"
	height="175"
	srcset="/posts/2024/07/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5%E4%BA%8C/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5/1721612144703-32325106-f9d5-46de-b8f4-cc11de3b0164-1724069074876-9_hu16922679724885553244.png 480w, /posts/2024/07/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5%E4%BA%8C/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5/1721612144703-32325106-f9d5-46de-b8f4-cc11de3b0164-1724069074876-9_hu12833693985632690199.png 1024w"
	loading="lazy"
	
		alt="img"
	
	
		class="gallery-image" 
		data-flex-grow="292"
		data-flex-basis="702px"
	
></p>
<p><strong>主备实时同步正常</strong></p>
<h4 id="2创建表插入数据操作">2）创建表、插入数据操作
</h4><p>打开达梦管理工具，连接到主库（192.168.163.9:5236），默认的管理员用户 <code>SYSDBA/SYSDBA</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">CREATE TABLE <span class="s2">&#34;TEST&#34;</span>.<span class="s2">&#34;ST_TEST_1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;BUSI_DATE&#34;</span> INTEGER,
</span></span><span class="line"><span class="cl"><span class="s2">&#34;NAME&#34;</span> VARCHAR2<span class="o">(</span>20<span class="o">)</span>,
</span></span><span class="line"><span class="cl"><span class="s2">&#34;AGE&#34;</span> VARCHAR2<span class="o">(</span>2<span class="o">)</span>,
</span></span><span class="line"><span class="cl"><span class="s2">&#34;SEX&#34;</span> VARCHAR2<span class="o">(</span>1<span class="o">))</span> STORAGE<span class="o">(</span>ON <span class="s2">&#34;TS_TEST&#34;</span>, CLUSTERBTR<span class="o">)</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">COMMENT ON COLUMN <span class="s2">&#34;TEST&#34;</span>.<span class="s2">&#34;ST_TEST_1&#34;</span>.<span class="s2">&#34;SEX&#34;</span> IS <span class="s1">&#39;1-男; 2-女&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">INSERT INTO <span class="s2">&#34;TEST&#34;</span>.<span class="s2">&#34;ST_TEST_1&#34;</span> <span class="o">(</span><span class="s2">&#34;BUSI_DATE&#34;</span>, <span class="s2">&#34;NAME&#34;</span>, <span class="s2">&#34;AGE&#34;</span>, <span class="s2">&#34;SEX&#34;</span><span class="o">)</span> VALUES <span class="o">(</span>20240702, <span class="s1">&#39;DY L&#39;</span>, <span class="s1">&#39;18&#39;</span>, <span class="s1">&#39;1&#39;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">INSERT INTO <span class="s2">&#34;TEST&#34;</span>.<span class="s2">&#34;ST_TEST_1&#34;</span> <span class="o">(</span><span class="s2">&#34;BUSI_DATE&#34;</span>, <span class="s2">&#34;NAME&#34;</span>, <span class="s2">&#34;AGE&#34;</span>, <span class="s2">&#34;SEX&#34;</span><span class="o">)</span> VALUES <span class="o">(</span>20240702, <span class="s1">&#39;DO W&#39;</span>, <span class="s1">&#39;19&#39;</span>, <span class="s1">&#39;1&#39;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">INSERT INTO <span class="s2">&#34;TEST&#34;</span>.<span class="s2">&#34;ST_TEST_1&#34;</span> <span class="o">(</span><span class="s2">&#34;BUSI_DATE&#34;</span>, <span class="s2">&#34;NAME&#34;</span>, <span class="s2">&#34;AGE&#34;</span>, <span class="s2">&#34;SEX&#34;</span><span class="o">)</span> VALUES <span class="o">(</span>20240702, <span class="s1">&#39;PE J&#39;</span>, <span class="s1">&#39;10&#39;</span>, <span class="s1">&#39;2&#39;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">INSERT INTO <span class="s2">&#34;TEST&#34;</span>.<span class="s2">&#34;ST_TEST_1&#34;</span> <span class="o">(</span><span class="s2">&#34;BUSI_DATE&#34;</span>, <span class="s2">&#34;NAME&#34;</span>, <span class="s2">&#34;AGE&#34;</span>, <span class="s2">&#34;SEX&#34;</span><span class="o">)</span> VALUES <span class="o">(</span>20240702, <span class="s1">&#39;DER K&#39;</span>, <span class="s1">&#39;52&#39;</span>, <span class="s1">&#39;1&#39;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">INSERT INTO <span class="s2">&#34;TEST&#34;</span>.<span class="s2">&#34;ST_TEST_1&#34;</span> <span class="o">(</span><span class="s2">&#34;BUSI_DATE&#34;</span>, <span class="s2">&#34;NAME&#34;</span>, <span class="s2">&#34;AGE&#34;</span>, <span class="s2">&#34;SEX&#34;</span><span class="o">)</span> VALUES <span class="o">(</span>20240702, <span class="s1">&#39;NC VC&#39;</span>, <span class="s1">&#39;60&#39;</span>, <span class="s1">&#39;2&#39;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">COMMIT<span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>连接备库（192.168.163.10:5236），验证是否有刚刚创建表和数据</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">TEST</span><span class="p">.</span><span class="n">ST_TEST_1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">BUSI_DATE</span><span class="w">   </span><span class="n">NAME</span><span class="w">    </span><span class="n">AGE</span><span class="w"> </span><span class="n">SEX</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="mi">20240702</span><span class="w">    </span><span class="n">DY</span><span class="w"> </span><span class="n">L</span><span class="w">    </span><span class="mi">18</span><span class="w">  </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="mi">20240702</span><span class="w">    </span><span class="k">DO</span><span class="w"> </span><span class="n">W</span><span class="w">    </span><span class="mi">19</span><span class="w">  </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="mi">20240702</span><span class="w">    </span><span class="n">PE</span><span class="w"> </span><span class="n">J</span><span class="w">    </span><span class="mi">10</span><span class="w">  </span><span class="mi">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="mi">20240702</span><span class="w">    </span><span class="n">DER</span><span class="w"> </span><span class="n">K</span><span class="w">   </span><span class="mi">52</span><span class="w">  </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="mi">20240702</span><span class="w">    </span><span class="n">NC</span><span class="w"> </span><span class="n">VC</span><span class="w">   </span><span class="mi">60</span><span class="w">  </span><span class="mi">2</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>主备实时同步正常</strong></p>
<h3 id="验证二备库写操作">验证二：备库写操作
</h3><p>因为备库是 <code>STANDBY</code> 模式，提供只读服务，是不能往备库操作对象的，所以看看是否模式生效</p>
<p>连接备库（192.168.163.10:5236），使用 <code>SYSDBA</code> 管理员用户试图创建一张表</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="p">[</span><span class="err">执行语句</span><span class="mi">1</span><span class="p">]:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="s2">&#34;TEST&#34;</span><span class="p">.</span><span class="s2">&#34;ST_TEST_2&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="s2">&#34;BUSI_DATE&#34;</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="s2">&#34;NAME&#34;</span><span class="w"> </span><span class="n">VARCHAR2</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="s2">&#34;AGE&#34;</span><span class="w"> </span><span class="n">VARCHAR2</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="s2">&#34;SEX&#34;</span><span class="w"> </span><span class="n">VARCHAR2</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="k">STORAGE</span><span class="p">(</span><span class="k">ON</span><span class="w"> </span><span class="s2">&#34;TS_TEST&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">CLUSTERBTR</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">执行失败</span><span class="p">(</span><span class="err">语句</span><span class="mi">1</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-</span><span class="mi">710</span><span class="p">:</span><span class="w"> </span><span class="err">试图在</span><span class="n">STANDBY模式下</span><span class="err">，修改用户库</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="mi">1</span><span class="err">条语句执行失败</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="err">执行语句</span><span class="mi">1</span><span class="p">]:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">TEST</span><span class="p">.</span><span class="n">ST_TEST_1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">执行失败</span><span class="p">(</span><span class="err">语句</span><span class="mi">1</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-</span><span class="mi">710</span><span class="p">:</span><span class="w"> </span><span class="err">试图在</span><span class="n">STANDBY模式下</span><span class="err">，修改用户库</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>主备模式正常</strong></p>
<h2 id="无监视器进行主备切换">无监视器进行主备切换
</h2><p>当异常发生时，没有配置监视器的实时主备，如何进行切换主备库？</p>
<p>直接使用 SQL 进行切换，切换之前，先使用 VMware 的快照功能备份一下当前的服务器状态，增加主备切换的容错，让自己能够使用快照快速恢复到刚刚搭建好集群的状态。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">-- 先将数据库切换为 Mount 状态
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux1 bin<span class="o">]</span>$ ./disql SYSDBA/SYSDBA
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">服务器<span class="o">[</span>LOCALHOST:5236<span class="o">]</span>:处于主库打开状态
</span></span><span class="line"><span class="cl">登录使用时间 : 37.834<span class="o">(</span>ms<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">disql V8
</span></span><span class="line"><span class="cl">SQL&gt; ALTER DATABASE MOUNT<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ALTER DATABASE MOUNT<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">第1 行附近出现错误<span class="o">[</span>-720<span class="o">]</span>:守护进程处于活动状态，或当前配置<span class="o">(</span>ALTER_MODE_STATUS<span class="o">)</span>不允许该操作.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">已用时间: 1.582<span class="o">(</span>毫秒<span class="o">)</span>. 执行号:0.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">##################################################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 需要先关闭数据守护 和 修改 ALTER_MODE_STATUS 参数</span>
</span></span><span class="line"><span class="cl"><span class="c1">##################################################</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>需要将守护进程关掉和模式的参数修改为可修改，才能切换</strong>，关掉守护进程的顺序：</p>
<p>备库的守护进程 &raquo; 主库的守护进程（其实无所谓）</p>
<h4 id="注意-1">【注意】
</h4><p>需要确保数据库中没有活动事务，手动切换需要将数据库调整为 mount 状态，它会回滚所以处于活动中的事务，已提交的事务不影响。</p>
<p>所以确保一下当下数据库事务的状态，如果有正在执行增删改操作的，强行调整的话，后续切换成功后，需要手动重新执行增删改的事务。</p>
<h3 id="a-机器操作主库操作">A 机器操作（主库操作）
</h3><p>主库切换为 PRIMARY 模式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux1 bin<span class="o">]</span>$ ./DmWatcherServiceWatcher stop
</span></span><span class="line"><span class="cl">Stopping DmWatcherServiceWatcher:                          <span class="o">[</span> OK <span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux1 bin<span class="o">]</span>$ ./disql SYSDBA/SYSDBA
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">服务器<span class="o">[</span>LOCALHOST:5236<span class="o">]</span>:处于主库打开状态
</span></span><span class="line"><span class="cl">登录使用时间 : 20.108<span class="o">(</span>ms<span class="o">)</span>
</span></span><span class="line"><span class="cl">disql V8
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SQL&gt; SP_SET_PARA_VALUE<span class="o">(</span>1,<span class="s1">&#39;ALTER_MODE_STATUS&#39;</span>,1<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">DMSQL 过程已成功完成
</span></span><span class="line"><span class="cl">已用时间: 37.106<span class="o">(</span>毫秒<span class="o">)</span>. 执行号:1001.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SQL&gt; ALTER DATABASE MOUNT<span class="p">;</span>
</span></span><span class="line"><span class="cl">操作已执行
</span></span><span class="line"><span class="cl">已用时间: 71.860<span class="o">(</span>毫秒<span class="o">)</span>. 执行号:0.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SQL&gt; ALTER DATABASE STANDBY<span class="p">;</span>
</span></span><span class="line"><span class="cl">操作已执行
</span></span><span class="line"><span class="cl">已用时间: 73.077<span class="o">(</span>毫秒<span class="o">)</span>. 执行号:0.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">##################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 非 NORMAL 模式需要 OPEN FORCE 强制开启</span>
</span></span><span class="line"><span class="cl"><span class="c1">##################</span>
</span></span><span class="line"><span class="cl">SQL&gt; ALTER DATABASE OPEN FORCE<span class="p">;</span>
</span></span><span class="line"><span class="cl">操作已执行
</span></span><span class="line"><span class="cl">已用时间: 33.830<span class="o">(</span>毫秒<span class="o">)</span>. 执行号:0.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SQL&gt; SP_SET_PARA_VALUE<span class="o">(</span>1,<span class="s1">&#39;ALTER_MODE_STATUS&#39;</span>,0<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">DMSQL 过程已成功完成
</span></span><span class="line"><span class="cl">已用时间: 36.470<span class="o">(</span>毫秒<span class="o">)</span>. 执行号:1002.
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="b-机器操作备库操作">B 机器操作（备库操作）
</h3><p>备库切换为 STANDBY 模式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux2 bin<span class="o">]</span>$ ./DmWatcherServiceWatcher stop
</span></span><span class="line"><span class="cl">Stopping DmWatcherServiceWatcher:                          <span class="o">[</span> OK <span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux2 bin<span class="o">]</span>$ ./disql SYSDBA/SYSDBA
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">服务器<span class="o">[</span>LOCALHOST:5236<span class="o">]</span>:处于备库打开状态
</span></span><span class="line"><span class="cl">登录使用时间 : 21.257<span class="o">(</span>ms<span class="o">)</span>
</span></span><span class="line"><span class="cl">disql V8
</span></span><span class="line"><span class="cl">SQL&gt; SP_SET_PARA_VALUE<span class="o">(</span>1,<span class="s1">&#39;ALTER_MODE_STATUS&#39;</span>,1<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">DMSQL 过程已成功完成
</span></span><span class="line"><span class="cl">已用时间: 36.238<span class="o">(</span>毫秒<span class="o">)</span>. 执行号:301.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SQL&gt; ALTER DATABASE MOUNT<span class="p">;</span>
</span></span><span class="line"><span class="cl">操作已执行
</span></span><span class="line"><span class="cl">已用时间: 20.816<span class="o">(</span>毫秒<span class="o">)</span>. 执行号:0.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SQL&gt; ALTER DATABASE PRIMARY<span class="p">;</span>
</span></span><span class="line"><span class="cl">操作已执行
</span></span><span class="line"><span class="cl">已用时间: 66.994<span class="o">(</span>毫秒<span class="o">)</span>. 执行号:0.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SQL&gt; ALTER DATABASE OPEN<span class="p">;</span>
</span></span><span class="line"><span class="cl">ALTER DATABASE OPEN<span class="p">;</span>
</span></span><span class="line"><span class="cl">第1 行附近出现错误<span class="o">[</span>-516<span class="o">]</span>:非NORMAL模式需要OPEN FORCE.
</span></span><span class="line"><span class="cl">已用时间: 0.959<span class="o">(</span>毫秒<span class="o">)</span>. 执行号:0.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SQL&gt; ALTER DATABASE OPEN FORCE<span class="p">;</span>
</span></span><span class="line"><span class="cl">操作已执行
</span></span><span class="line"><span class="cl">已用时间: 93.506<span class="o">(</span>毫秒<span class="o">)</span>. 执行号:0.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SQL&gt; SP_SET_PARA_VALUE<span class="o">(</span>1,<span class="s1">&#39;ALTER_MODE_STATUS&#39;</span>,0<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">DMSQL 过程已成功完成
</span></span><span class="line"><span class="cl">已用时间: 32.835<span class="o">(</span>毫秒<span class="o">)</span>. 执行号:302.
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="启动数据守护">启动数据守护
</h3><p>A \ B 机器都启动</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux1 bin<span class="o">]</span>$ ./DmWatcherServiceWatcher start
</span></span><span class="line"><span class="cl">Starting DmWatcherServiceWatcher:                          <span class="o">[</span> OK <span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="验证切换是否成功">验证切换是否成功
</h3><h4 id="查看实例的模式">查看实例的模式
</h4><p>A 机器查看，因为已经将 A 切换为备库了，所以 <code>./disql</code> 会显示处于备库打开状态</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux1 bin<span class="o">]</span>$ ./disql SYSDBA/SYSDBA
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">服务器<span class="o">[</span>LOCALHOST:5236<span class="o">]</span>:处于备库打开状态
</span></span><span class="line"><span class="cl">登录使用时间 : 18.106<span class="o">(</span>ms<span class="o">)</span>
</span></span><span class="line"><span class="cl">disql V8
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SQL&gt; SELECT NAME, INSTANCE_NAME, STATUS$, MODE$ FROM V<span class="nv">$INSTANCE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">行号     NAME        INSTANCE_NAME STATUS$ MODE$
</span></span><span class="line"><span class="cl">---------- ----------- ------------- ------- -------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">1</span>          GRP_TEST_01 GRP_TEST_01   OPEN    STANDBY
</span></span></code></pre></td></tr></table>
</div>
</div><p>B 机器查看，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux2 bin<span class="o">]</span>$ ./disql SYSDBA/SYSDBA
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">服务器<span class="o">[</span>LOCALHOST:5236<span class="o">]</span>:处于主库打开状态
</span></span><span class="line"><span class="cl">登录使用时间 : 31.640<span class="o">(</span>ms<span class="o">)</span>
</span></span><span class="line"><span class="cl">disql V8
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SQL&gt; SELECT NAME, INSTANCE_NAME, STATUS$, MODE$ FROM V<span class="nv">$INSTANCE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">行号     NAME        INSTANCE_NAME STATUS$ MODE$
</span></span><span class="line"><span class="cl">---------- ----------- ------------- ------- -------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">1</span>          GRP_TEST_02 GRP_TEST_02   OPEN    PRIMARY
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="在主库操作">在主库操作
</h4><p>主库执行 SQL</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="s2">&#34;TEST&#34;</span><span class="p">.</span><span class="s2">&#34;T_LISTAGG_TEST&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="w"> </span><span class="s2">&#34;ID&#34;</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="s2">&#34;C1&#34;</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">4000</span><span class="p">))</span><span class="w"> </span><span class="k">STORAGE</span><span class="p">(</span><span class="k">ON</span><span class="w"> </span><span class="s2">&#34;TS_TEST&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">CLUSTERBTR</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在备库中查看是否同步，已同步证明没问题</p>
<h2 id="确认监视器自动切换验证">确认监视器自动切换验证
</h2><p>在【6 无监视器进行主备切换】步骤中，已经把 A 机器(GRP_TEST_01)切换为备库，B 机器(GRP_TEST_02)切换为主库了。</p>
<p>把主库 <code>GRP_TEST_02</code> 挂掉（即把主库的DmWatcher守护进程服务、DmService服务停止掉），然后使用达梦管理工具使用服务名进入数据库，查看是否连接到 <code>GRP_TEST_01</code> 并且将该数据库是模式切换为 <code>PRIMARY</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain"><span class="line"><span class="cl">[dmdba@linux2 bin]$ ./DmWatcherServiceWatcher stop
</span></span><span class="line"><span class="cl">Stopping DmWatcherServiceWatcher:                          [ OK ]
</span></span><span class="line"><span class="cl">[dmdba@linux2 bin]$ ./DmServiceGRP_TEST_02 stop
</span></span><span class="line"><span class="cl">Stopping DmServiceGRP_TEST_02:                             [ OK ]
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/posts/2024/07/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5%E4%BA%8C/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5/1721657173375-74eb619f-a66d-455a-8d3d-069887a8049a-1724069074876-11.png"
	width="613"
	height="169"
	srcset="/posts/2024/07/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5%E4%BA%8C/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5/1721657173375-74eb619f-a66d-455a-8d3d-069887a8049a-1724069074876-11_hu226724922318342311.png 480w, /posts/2024/07/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5%E4%BA%8C/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5/1721657173375-74eb619f-a66d-455a-8d3d-069887a8049a-1724069074876-11_hu17650232337169436469.png 1024w"
	loading="lazy"
	
		alt="img"
	
	
		class="gallery-image" 
		data-flex-grow="362"
		data-flex-basis="870px"
	
></p>
<p>确认是自动切换了 OK</p>
<h2 id="非确认监视器切换">非确认监视器切换
</h2><p>这里就不再详细说明了，把确认监视器失效掉（把里边的 <code>MON_DW_CONFIRM</code> 改为 1），然后使用非确认监视器</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain"><span class="line"><span class="cl"># 前台方式进入非确认监视器
</span></span><span class="line"><span class="cl">cd /home/dmdba/dmdbms/bin
</span></span><span class="line"><span class="cl">./dmmonitor /home/dmdba/dmdbms/DMDB/dmmonitor_manual.ini
</span></span><span class="line"><span class="cl"># 检查集群状态
</span></span><span class="line"><span class="cl">tip
</span></span><span class="line"><span class="cl"># 登录非确认监视器：使用有 DBA 权限的用户，我用 SYSBDA
</span></span><span class="line"><span class="cl">login
</span></span><span class="line"><span class="cl"># 查看满足切换条件的实例
</span></span><span class="line"><span class="cl">choose switchover GRP1
</span></span><span class="line"><span class="cl"># 进行主备切换
</span></span><span class="line"><span class="cl">switchover GRP1.GRP_TEST_01
</span></span><span class="line"><span class="cl"># 切换成功，退出监视器
</span></span><span class="line"><span class="cl">logout
</span></span><span class="line"><span class="cl"># 再次查看集群状态
</span></span><span class="line"><span class="cl">tip
</span></span><span class="line"><span class="cl"># 正常了，退出非确认监视器即可
</span></span><span class="line"><span class="cl">exit
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="报错问题">报错问题
</h2><p>主要还是步骤并没有按顺序来导致的，或者配置文件里配置错误导致</p>
<h3 id="启动数据守护报错">启动数据守护报错
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux1 bin<span class="o">]</span>$ ./dmwatcher /home/dmdba/dmdbms/DMDB/dmwatcher.ini
</span></span><span class="line"><span class="cl">DMWATCHER<span class="o">[</span>4.0<span class="o">]</span> V8
</span></span><span class="line"><span class="cl">Invalid <span class="o">[</span>mal_name<span class="o">]</span> or the file contains unrecognized characters in <span class="o">[</span>/home/dmdba/dmdbms/DMDB/dmmal.ini<span class="o">]</span>!
</span></span><span class="line"><span class="cl">Read ini file<span class="o">(</span>/home/dmdba/dmdbms/DMDB/dmmal.ini<span class="o">)</span> error in line 1, code<span class="o">(</span>-104<span class="o">)</span>
</span></span><span class="line"><span class="cl">Read dm.ini<span class="o">(</span>/home/dmdba/dmdbms/DMDB/dm.ini<span class="o">)</span> failed, <span class="nv">code</span> <span class="o">=</span> -104!
</span></span><span class="line"><span class="cl">fail to <span class="nb">read</span> ini file
</span></span></code></pre></td></tr></table>
</div>
</div><p>读两个文件报错了，第一个报错给出了明确的列</p>
<p><code>dmmal.ini</code> 的第一列报错，查看了一下，复制进shell的时候，缺少了 MA 两个字母，补充形成完整的</p>
<p><code>MAL_CHECK_INTERVAL</code> 参数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nv">MAL_CHECK_INTERVAL</span>         <span class="o">=</span> <span class="m">10</span>  <span class="c1">#MAL 链路检测时间间隔</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后重新启动就成功了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux1 bin<span class="o">]</span>$ ./DmWatcherServiceWatcher start
</span></span><span class="line"><span class="cl">Starting DmWatcherServiceWatcher:                          <span class="o">[</span> OK <span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="启动数据库实例报错">启动数据库实例报错
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>dmdba@linux1 bin<span class="o">]</span>$ ./DmServiceGRP_TEST_01 start
</span></span><span class="line"><span class="cl">Starting DmServiceGRP_TEST_01:                             <span class="o">[</span> FAILED <span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看日志 <code>dm_实例名_年月.log</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">2024-07-21 11:22:01.998 <span class="o">[</span>INFO<span class="o">]</span> database P0000036451 T0000000000000036513  utsk_tcp_conn_validate failed, seqno:0, from_name:, code:-9423!
</span></span><span class="line"><span class="cl">2024-07-21 11:22:03.014 <span class="o">[</span>INFO<span class="o">]</span> database P0000036451 T0000000000000036513  Dmwatcher oguid<span class="o">(</span>45331<span class="o">)</span> is not match with <span class="nb">local</span> dmserver oguid<span class="o">(</span>0<span class="o">)</span>, code -9423, cannot build connection!
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看数据守护的日志 <code>dm_dmwatcher_实例名_年月.log</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">2024-07-21 11:26:58.830 <span class="o">[</span>INFO<span class="o">]</span> dmwatcher P0000036411 T0000000000000036416  dw2_tcp_conn_startup, oguid<span class="o">(</span>45331<span class="o">)</span> configured in dmwatcher.ini not equal with <span class="nb">local</span> dmserver<span class="err">&#39;</span>s oguid<span class="o">(</span>0<span class="o">)</span>!
</span></span></code></pre></td></tr></table>
</div>
</div><p>是因为没有启动数据库，并到数据库里修改 <code>OGUID</code> 参数导致。看上边启动服务步骤。</p>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/%E4%BF%A1%E5%88%9B/">信创</a>
        
            <a href="/tags/%E8%BE%BE%E6%A2%A6/">达梦</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    <section class="article-lastmod">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



        <span>
            最后更新于 2024年10月14号 22:36
        </span>
    </section></footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/posts/2024/08/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E8%BF%98%E5%8E%9F%E5%AE%9E%E8%B7%B5%E5%9B%9B/">
        
        

        <div class="article-details">
            <h2 class="article-title">主备集群 达梦数据库备份还原实践（四）</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/posts/2024/08/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E6%96%B0%E5%A2%9E%E8%BE%BE%E6%A2%A6%E5%AE%9E%E4%BE%8B%E5%B9%B6%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%97%B6%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E4%B8%89/">
        
        

        <div class="article-details">
            <h2 class="article-title">主备集群 新增达梦实例并配置实时主备集群（三）</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/posts/2024/07/%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4-%E8%BE%BE%E6%A2%A6%E6%95%B0%E6%8D%AE%E5%BA%93%E6%95%B0%E6%8D%AE%E5%AE%88%E6%8A%A4%E4%B8%80/">
        
        

        <div class="article-details">
            <h2 class="article-title">主备集群 达梦数据库数据守护（一）</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/posts/2024/06/%E5%AE%9E%E6%96%BD%E9%83%A8%E7%BD%B2-%E8%BE%BE%E6%A2%A6%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AE%89%E8%A3%85/">
        
        

        <div class="article-details">
            <h2 class="article-title">实施部署 达梦数据库linux版的安装（二）</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/posts/2024/06/%E5%AE%9E%E6%96%BD%E9%83%A8%E7%BD%B2-%E4%BF%A1%E5%88%9B%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%96%BD%E5%87%86%E5%A4%87/">
        
        

        <div class="article-details">
            <h2 class="article-title">实施部署 信创项目环境搭建准备（一）</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2024 Wei Qi
    </section>
    
    <section class="powerby">
        

        

        
        
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        

        
        
        
        
        <a>发布了 28 篇文章 | 共 88.8K 字</a></br>
        <a>总访客数: </a><span id='busuanzi_value_site_uv'>Loading</span> <a> | </a> <a>总访问量: </a><span id='busuanzi_value_site_pv'>Loading</span></br>


        <section class="powerby">
            <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.27.0">Stack</a></b> <a>designed by Jimmy</a>
        </section>

    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

<script
    src="https://cdn.jsdelivr.net/gh/zhixuan2333/gh-blog@v0.1.0/js/nprogress.min.js"
    integrity="sha384-bHDlAEUFxsRI7JfULv3DTpL2IXbbgn4JHQJibgo5iiXSK6Iu8muwqHANhun74Cqg"
    crossorigin="anonymous"
></script>
<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/zhixuan2333/gh-blog@v0.1.0/css/nprogress.css"
    integrity="sha384-KJyhr2syt5+4M9Pz5dipCvTrtvOmLk/olWVdfhAp858UCa64Ia5GFpTN7+G4BWpE"
    crossorigin="anonymous"
/>
<script>
    NProgress.start();
    document.addEventListener("readystatechange", () => {
        if (document.readyState === "interactive") NProgress.inc(0.8);
        if (document.readyState === "complete") NProgress.done();
    });
</script>
<script defer src="https://cn.vercount.one/js"></script>
    </body>
</html>
